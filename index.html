<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NoShopiA - Reutiliza tu ropa con IA</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --primary: #3b82f6; --text-primary: #1f2937; --text-secondary: #6b7280; --background: #ffffff;
      --border: #e5e7eb; --accent: #10b981; --warning: #f59e0b; --error: #ef4444; --success: #10b981; --gold: #fbbf24;
      --surface: #f8fafc; --surface-hover: #f1f5f9;
    }
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Poppins', -apple-system, BlinkMacSystemFont, sans-serif; line-height: 1.6; overflow-x: hidden;
      background: var(--background); color: #000000; min-height: 100vh; font-size: 1.2em;
    }
    .container { max-width: 1200px; margin: 0 auto; padding: 0 2rem; }
    .section { padding: 6rem 5%; position: relative; z-index: 2; background: var(--background); }
    .section-title { text-align: center; margin-bottom: 4rem; }
    .section-title h2 { font-size: 2.5rem; font-weight: 800; margin-bottom: 1rem; color: #000000; }
    .section-subtitle { font-size: 1.2rem; max-width: 600px; margin: 0 auto; color: #000000; opacity: 0.8; }
    
    /* Header & Navigation */
    header {
      position: fixed; top: 0; width: 100%; padding: 1rem 5%; background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px); border-bottom: 1px solid var(--border); z-index: 1000; transition: all 0.3s ease;
    }
    nav { display: flex; justify-content: space-between; align-items: center; max-width: 1200px; margin: 0 auto; }
    .logo { font-size: 3rem; font-weight: 900; display: flex; align-items: center; letter-spacing: 1px; }
    .logo-no { color: #ef4444; } .logo-shop { color: #000000; } .logo-i, .logo-a { color: #22c55e; }
    .nav-pills {
      display: flex; background: rgba(59, 130, 246, 0.1); padding: 0.5rem; border-radius: 50px; gap: 0.5rem;
    }
    .nav-pill {
      padding: 0.7rem 1.5rem; border-radius: 25px; color: #000000; text-decoration: none; font-weight: 500;
      transition: all 0.3s ease; display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem;
    }
    .nav-pill:hover, .nav-pill.active { background: rgba(59, 130, 246, 0.2); transform: translateY(-2px); }
    
    /* Enhanced Buttons */
    .btn {
      padding: 1.2rem 3rem; border: none; border-radius: 50px; font-weight: 600; font-size: 1.1rem;
      cursor: pointer; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 0.8rem;
      text-decoration: none; outline: none; box-sizing: border-box;
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--primary), #1d4ed8); color: white;
      box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
    }
    .btn-primary:hover { transform: translateY(-3px); box-shadow: 0 15px 40px rgba(59, 130, 246, 0.4); }
    .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
    .btn-secondary {
      background: rgba(59, 130, 246, 0.1); color: var(--primary); border: 2px solid var(--primary);
    }
    .btn-secondary:hover { background: var(--primary); color: white; transform: translateY(-2px); }
    .btn-success {
      background: linear-gradient(135deg, var(--success), #059669); color: white;
      box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);
    }
    .btn-success:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 15px 40px rgba(16, 185, 129, 0.4); }
    .btn-danger {
      background: linear-gradient(135deg, var(--error), #dc2626); color: white;
      box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
    }
    .btn-danger:hover { transform: translateY(-3px); box-shadow: 0 15px 40px rgba(239, 68, 68, 0.4); }
    
    /* Hero Section */
    .hero {
      min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center;
      text-align: center; position: relative; z-index: 2; padding: 6rem 2rem 4rem; background: var(--background);
    }
    .hero h1 { font-size: clamp(2.5rem, 6vw, 4rem); font-weight: 800; margin-bottom: 1rem; color: #000000; line-height: 1.2; }
    .hero-subtitle { font-size: 1.3rem; margin-bottom: 0.5rem; font-weight: 600; color: #000000; }
    
    /* Grid Layouts */
    .grid { display: grid; gap: 2rem; }
    .grid-2 { grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); }
    .grid-3 { grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); }
    .grid-4 { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
    .grid-5 { grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); }
    
    /* Enhanced Card Components */
    .card {
      background: var(--background); border-radius: 25px; padding: 3rem 2rem; border: 1px solid var(--border);
      transition: all 0.3s ease; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .card:hover { transform: translateY(-10px); box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15); }
    .card-compact { padding: 2rem 1.5rem; }
    .card-icon { font-size: 3rem; margin-bottom: 1rem; color: var(--primary); }
    .card-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 1rem; color: #000000; }
    
    /* Form Sections */
    .form-section {
      background: rgba(59, 130, 246, 0.05); border: 2px solid rgba(59, 130, 246, 0.2);
      border-radius: 20px; padding: 3rem 2rem; margin: 2rem 0; animation: fadeInUp 0.6s ease-out;
    }
    .form-options { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
    .form-option {
      background: var(--background); border: 2px solid var(--border); border-radius: 15px; padding: 1rem 0.5rem;
      cursor: pointer; transition: all 0.3s ease; display: flex; flex-direction: column; align-items: center;
      gap: 0.5rem; font-size: 0.9rem; font-weight: 500; color: #000000; text-align: center;
      min-height: 80px; justify-content: center;
    }
    .form-option:hover { transform: translateY(-3px); border-color: var(--primary); background: rgba(59, 130, 246, 0.1); }
    .form-option.selected {
      border-color: var(--primary); background: rgba(59, 130, 246, 0.15); transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(59, 130, 246, 0.3);
    }
    
    /* Upload Components */
    .upload-area {
      background: rgba(59, 130, 246, 0.02); border: 2px dashed var(--border);
      border-radius: 25px; padding: 4rem 2rem; margin: 2rem 0;
    }
    .file-input { display: none; }
    .file-label {
      display: block; padding: 1rem 2rem; background: var(--primary); border-radius: 25px;
      color: white; font-weight: 600; cursor: pointer; transition: all 0.3s ease; margin-top: 1rem;
    }
    .file-label:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(59, 130, 246, 0.3); }
    .file-label.disabled {
      background: #ccc; cursor: not-allowed; transform: none; box-shadow: none;
    }
    .preview-area {
      margin-top: 1rem; display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center;
    }
    .preview-container {
      position: relative; display: inline-block;
    }
    .preview-image {
      width: 120px; height: 120px; object-fit: cover; border-radius: 15px;
      border: 2px solid var(--primary); position: relative;
    }
    .remove-image {
      position: absolute; top: -8px; right: -8px; background: #ef4444; color: white; border: none;
      border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 12px;
      display: flex; align-items: center; justify-content: center;
    }
    
    /* Closet Selection */
    .closet-selection {
      background: rgba(16, 185, 129, 0.05); border: 2px solid rgba(16, 185, 129, 0.2);
      border-radius: 20px; padding: 2rem; margin: 2rem 0;
    }
    .closet-item {
      background: var(--background); border: 2px solid var(--border); border-radius: 15px;
      padding: 1rem; margin: 0.5rem; cursor: pointer; transition: all 0.3s ease;
      display: inline-block; position: relative;
    }
    .closet-item:hover { border-color: var(--success); transform: translateY(-2px); }
    .closet-item.selected {
      border-color: var(--success); background: rgba(16, 185, 129, 0.1);
      box-shadow: 0 5px 15px rgba(16, 185, 129, 0.3);
    }
    .closet-item img {
      width: 80px; height: 80px; object-fit: cover; border-radius: 10px;
    }
    .selection-badge {
      position: absolute; top: -8px; right: -8px; background: var(--success);
      color: white; border-radius: 50%; width: 24px; height: 24px;
      display: flex; align-items: center; justify-content: center; font-weight: bold;
    }
    
    /* Counters and Stats */
    .counter-display {
      background: rgba(59, 130, 246, 0.1); border-radius: 15px; padding: 1rem;
      margin: 1rem 0; text-align: center; font-weight: 600;
    }
    .counter-item {
      display: inline-block; margin: 0 1rem; padding: 0.5rem 1rem;
      background: var(--background); border-radius: 10px; border: 1px solid var(--border);
    }
    .counter-warning {
      background: rgba(239, 68, 68, 0.1); border-color: var(--error); color: var(--error);
    }
    .counter-success {
      background: rgba(16, 185, 129, 0.1); border-color: var(--success); color: var(--success);
    }
    
    /* Combinations Display */
    .combinations-info {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(16, 185, 129, 0.1));
      border-radius: 15px; padding: 1.5rem; margin: 1rem 0; text-align: center;
    }
    .combinations-formula {
      font-size: 1.2rem; font-weight: 700; color: var(--primary); margin-bottom: 0.5rem;
    }
    .combinations-result {
      font-size: 1rem; color: #000000; opacity: 0.8;
    }
    
    /* Notifications */
    .notification {
      position: fixed; top: 20px; right: 20px; padding: 1rem 2rem; border-radius: 15px; color: white;
      font-weight: 600; z-index: 10000; max-width: 350px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      animation: slideInRight 0.3s ease;
    }
    .notification.success { background: linear-gradient(135deg, #10b981, #059669); }
    .notification.error { background: linear-gradient(135deg, #ef4444, #dc2626); }
    .notification.info { background: linear-gradient(135deg, var(--primary), #1d4ed8); }
    
    /* Enhanced Modal */
    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);
      z-index: 10000; display: none; align-items: center; justify-content: center;
      backdrop-filter: blur(5px); animation: fadeIn 0.3s ease;
    }
    .modal {
      background: var(--background); border-radius: 20px; padding: 2rem; max-width: 400px; width: 90%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: scaleIn 0.3s ease;
    }
    .modal h3 { margin-bottom: 1rem; color: #000000; text-align: center; }
    .modal p { margin-bottom: 2rem; color: var(--text-secondary); text-align: center; }
    .modal-actions { display: flex; gap: 1rem; justify-content: center; }
    
    /* Mode Indicator */
    .mode-indicator {
      position: fixed; top: 100px; right: 20px; background: var(--primary); color: white;
      padding: 0.5rem 1rem; border-radius: 25px; font-size: 0.8rem; font-weight: 600; z-index: 1000;
      box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3); display: none;
    }
    .mode-indicator.closet { background: var(--gold); color: #000000; }
    
    /* Animations */
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes scaleIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading {
      display: inline-block; width: 20px; height: 20px; border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%; border-top-color: #ffffff; animation: spin 1s ease-in-out infinite;
    }
    
    /* Utility Classes */
    .hidden { display: none !important; }
    .text-center { text-align: center; }
    .mb-2 { margin-bottom: 2rem; }
    .mt-2 { margin-top: 2rem; }
    
    /* Responsive */
    @media (max-width: 768px) {
      .nav-pills { display: none; }
      .logo { font-size: 2rem; }
      .form-options { grid-template-columns: 1fr; }
      .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; }
      .grid-5 { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 480px) {
      .grid-5 { grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <!-- Logout Modal -->
  <div id="logoutModal" class="modal-overlay">
    <div class="modal">
      <h3>¿Cerrar sesión?</h3>
      <p>¿Estás seguro que deseas salir de tu cuenta?</p>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeLogoutModal()">Cancelar</button>
        <button class="btn btn-danger" onclick="confirmLogout()">Salir</button>
      </div>
    </div>
  </div>

  <header>
    <nav>
      <div class="logo">
        <span class="logo-no">No</span><span class="logo-shop">shop</span><span class="logo-i">i</span><span class="logo-a">A</span>
      </div>
      
      <div style="display: flex; align-items: center;">
        <div class="nav-pills">
          <a href="#inicio" class="nav-pill active" data-section="inicio">🏠 Inicio</a>
          <a href="#funcionamiento" class="nav-pill" data-section="funcionamiento">⚙️ Cómo funciona</a>
        </div>
        
        <div class="auth-container">
          <div id="g_id_onload"
               data-client_id="326940877598-ko13n1qcqkkugkoo6gu2n1avs46al09p.apps.googleusercontent.com"
               data-context="signin"
               data-ux_mode="popup"
               data-callback="handleCredentialResponse"
               data-auto_prompt="false">
          </div>
          
          <div id="googleSignInBtn" class="g_id_signin" 
               data-type="standard"
               data-shape="pill"
               data-theme="outline"
               data-text="signin_with"
               data-size="large"
               data-logo_alignment="left">
          </div>
          
          <div class="user-info" id="userInfo" style="display: none;">
            <img class="user-avatar" id="userAvatar" alt="Usuario" style="width: 35px; height: 35px; border-radius: 50%; border: 2px solid var(--primary);"/>
            <span id="userName" style="color: #000000;"></span>
            <button onclick="showLogoutModal()" class="btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.9rem;">Salir</button>
          </div>
        </div>
      </div>
    </nav>
  </header>

  <div id="modeIndicator" class="mode-indicator">Modo no seleccionado</div>

  <!-- Hero Section -->
  <section id="inicio" class="hero">
    <div style="max-width: 900px;">
      <span style="font-size: 4rem; margin-bottom: 1rem; display: block;">🚫🛍️👕</span>
      <h1>Reutiliza tu ropa con IA y minimiza tu Impacto Ambiental</h1>
      <p class="hero-subtitle">¿Tardas mucho eligiendo qué ponerte cada mañana?</p>
      <p style="font-size: 1.1rem; color: #000000; opacity: 0.8; margin-bottom: 3rem; max-width: 700px; margin-left: auto; margin-right: auto;">
        Descubre combinaciones únicas con tu ropa actual gracias a nuestra inteligencia artificial. Sin estrés, sin pérdida de tiempo, solo outfits perfectos que cuidan el planeta.
      </p>
      
      <div id="heroGoogleAuth" style="display: flex; justify-content: center; margin-bottom: 2rem;">
        <div class="g_id_signin" 
             data-type="standard"
             data-shape="pill"
             data-theme="filled_blue"
             data-text="signin_with"
             data-size="large"
             data-logo_alignment="left">
        </div>
      </div>
      
      <div class="grid grid-3 mt-2" style="max-width: 800px;">
        <div class="card card-compact">
          <span style="font-size: 2.5rem; font-weight: 900; color: var(--primary); margin-bottom: 0.5rem; display: block;">15min</span>
          <span style="color: #000000; opacity: 0.7;">Ahorrados cada mañana</span>
        </div>
        <div class="card card-compact">
          <span style="font-size: 2.5rem; font-weight: 900; color: var(--primary); margin-bottom: 0.5rem; display: block;">10s</span>
          <span style="color: #000000; opacity: 0.7;">Para generar outfit</span>
        </div>
        <div class="card card-compact">
          <span style="font-size: 2.5rem; font-weight: 900; color: var(--primary); margin-bottom: 0.5rem; display: block;">25kg</span>
          <span style="color: #000000; opacity: 0.7;">CO₂ reducido</span>
        </div>
      </div>
    </div>
  </section>

  <!-- How it Works Section -->
  <section id="funcionamiento" class="section">
    <div class="container">
      <div class="section-title">
        <h2>⚙️ Cómo Funciona</h2>
        <p class="section-subtitle">Descubre combinaciones únicas con tu ropa actual en solo tres simples pasos</p>
      </div>
      <div class="grid grid-3 mt-2">
        <div class="card">
          <div style="font-size: 4rem; margin-bottom: 2rem; display: block;">📱</div>
          <h3 class="card-title">1. Sube tus prendas</h3>
          <p style="color: #000000; opacity: 0.8; line-height: 1.6;">Fotografía las prendas que quieres incluir: superiores, inferiores y calzado. Nuestra IA analiza cada pieza automáticamente.</p>
        </div>
        <div class="card">
          <div style="font-size: 4rem; margin-bottom: 2rem; display: block;">🤖</div>
          <h3 class="card-title">2. IA genera recomendaciones</h3>
          <p style="color: #000000; opacity: 0.8; line-height: 1.6;">Nuestro algoritmo avanzado analiza colores, estilos, ocasiones y tendencias para crear outfits únicos y balanceados.</p>
        </div>
        <div class="card">
          <div style="font-size: 4rem; margin-bottom: 2rem; display: block;">✨</div>
          <h3 class="card-title">3. Recibe sugerencias</h3>
          <p style="color: #000000; opacity: 0.8; line-height: 1.6;">Obtén recomendaciones personalizadas rankeadas por score de compatibilidad en menos de 10 segundos.</p>
        </div>
      </div>
    </div>
  </section>

  <!-- Upload Section -->
  <section id="upload" class="section" style="background: rgba(249, 250, 251, 0.5);">
    <div class="container">
      <div class="section-title">
        <h2>✨ Tu Guardarropa Digital Personalizado</h2>
        <p class="section-subtitle">Sube fotos de la ropa que ya tienes y descubre combinaciones increíbles</p>
      </div>

      <!-- Welcome Section -->
      <div id="welcomeSection" class="form-section" style="display: none; background: rgba(34, 197, 94, 0.05); border-color: rgba(34, 197, 94, 0.2);">
        <h3 class="text-center mb-2">🎉 ¡Bienvenido a NoshopiA!</h3>
        <p class="text-center mb-2" style="opacity: 0.8;">Tu perfil ha sido creado exitosamente. Ahora puedes comenzar a usar el sistema de recomendaciones.</p>
      </div>

      <!-- Mode Selector -->
      <div id="closetQuestion" class="form-section hidden">
        <h3 class="text-center mb-2">👗 ¿Cómo quieres usar NoshopiA?</h3>
        <p class="text-center mb-2" style="opacity: 0.8;">Elige la forma que mejor se adapte a tu estilo</p>
        
        <div class="grid grid-2">
          <div class="card card-compact" onclick="enableCloset()" style="cursor: pointer;">
            <div class="card-icon">📦</div>
            <h4 class="card-title">Mi Closet Digital</h4>
            <p style="opacity: 0.7; font-size: 0.9rem;">Guarda hasta 15 prendas, organiza por categorías y selecciona cuáles usar</p>
          </div>
          
          <div class="card card-compact" onclick="useDirectMode()" style="cursor: pointer;">
            <div class="card-icon">⚡</div>
            <h4 class="card-title">Recomendaciones Rápidas</h4>
            <p style="opacity: 0.7; font-size: 0.9rem;">Sube fotos directamente y obtén recomendaciones instantáneas</p>
          </div>
        </div>
      </div>

      <!-- Closet Selection (for closet mode) -->
      <div id="closetSelection" class="closet-selection hidden">
        <h3 class="text-center mb-2">📦 Selecciona las prendas que quieres usar</h3>
        <p class="text-center mb-2" style="opacity: 0.8;">De tu closet digital, elige las prendas para generar recomendaciones</p>
        
        <div id="closetItemsDisplay">
          <div class="mb-2">
            <h4>👕 Superiores disponibles:</h4>
            <div id="closetTopsSelection"></div>
          </div>
          <div class="mb-2">
            <h4>👖 Inferiores disponibles:</h4>
            <div id="closetBottomsSelection"></div>
          </div>
          <div class="mb-2">
            <h4>👠 Calzado disponible:</h4>
            <div id="closetShoesSelection"></div>
          </div>
        </div>
      </div>

      <!-- Occasion Selector -->
      <div id="occasionSelector" class="form-section hidden">
        <h3 class="text-center mb-2">🎯 ¿Para qué ocasión necesitas el outfit?</h3>
        <p class="text-center mb-2" style="opacity: 0.8;">La ocasión afecta el score de compatibilidad</p>
        <div class="grid grid-5" id="occasionGrid">
          <button class="card card-compact" data-occasion="oficina" style="cursor: pointer;">
            <i class="fas fa-briefcase" style="font-size: 2rem; color: var(--primary); margin-bottom: 0.8rem;"></i>
            <span style="color: #000000; font-weight: 500;">Oficina</span>
          </button>
          <button class="card card-compact" data-occasion="deportivo" style="cursor: pointer;">
            <i class="fas fa-dumbbell" style="font-size: 2rem; color: var(--primary); margin-bottom: 0.8rem;"></i>
            <span style="color: #000000; font-weight: 500;">Deportes/Gym</span>
          </button>
          <button class="card card-compact" data-occasion="casual" style="cursor: pointer;">
            <i class="fas fa-users" style="font-size: 2rem; color: var(--primary); margin-bottom: 0.8rem;"></i>
            <span style="color: #000000; font-weight: 500;">Casual</span>
          </button>
          <button class="card card-compact" data-occasion="formal" style="cursor: pointer;">
            <i class="fas fa-black-tie" style="font-size: 2rem; color: var(--primary); margin-bottom: 0.8rem;"></i>
            <span style="color: #000000; font-weight: 500;">Formal</span>
          </button>
          <button class="card card-compact" data-occasion="matrimonio" style="cursor: pointer;">
            <i class="fas fa-ring" style="font-size: 2rem; color: var(--primary); margin-bottom: 0.8rem;"></i>
            <span style="color: #000000; font-weight: 500;">Matrimonio</span>
          </button>
        </div>
      </div>

      <!-- Upload Area -->
      <div class="upload-area hidden" id="uploadArea">
        <div id="countersDisplay" class="counter-display hidden">
          <div class="counter-item" id="topsCounter">Superiores: 0/3</div>
          <div class="counter-item" id="bottomsCounter">Inferiores: 0/3</div>
          <div class="counter-item" id="shoesCounter">Zapatos: 0/5</div>
          <div class="counter-item" id="totalCounter">Total: 0/15</div>
        </div>

        <div class="grid grid-3" id="uploadGrid">
          <div class="card card-compact">
            <i class="fas fa-tshirt" style="font-size: 2.5rem; color: var(--primary); margin-bottom: 1rem;"></i>
            <h4 style="color: #000000; margin-bottom: 0.5rem;">Parte Superior</h4>
            <p style="color: #000000; opacity: 0.8; margin-bottom: 1rem;">Camisas, blusas, suéteres</p>
            <label for="tops-upload" class="file-label" id="tops-label">📤 Subir Superiores</label>
            <input type="file" id="tops-upload" class="file-input" accept="image/*" multiple />
            <div id="tops-preview" class="preview-area"></div>
          </div>
          <div class="card card-compact">
            <i class="fas fa-user-tie" style="font-size: 2.5rem; color: var(--primary); margin-bottom: 1rem;"></i>
            <h4 style="color: #000000; margin-bottom: 0.5rem;">Parte Inferior</h4>
            <p style="color: #000000; opacity: 0.8; margin-bottom: 1rem;">Pantalones, faldas, shorts</p>
            <label for="bottoms-upload" class="file-label" id="bottoms-label">📤 Subir Inferiores</label>
            <input type="file" id="bottoms-upload" class="file-input" accept="image/*" multiple />
            <div id="bottoms-preview" class="preview-area"></div>
          </div>
          <div class="card card-compact">
            <i class="fas fa-shoe-prints" style="font-size: 2.5rem; color: var(--primary); margin-bottom: 1rem;"></i>
            <h4 style="color: #000000; margin-bottom: 0.5rem;">Calzado</h4>
            <p style="color: #000000; opacity: 0.8; margin-bottom: 1rem;">Zapatos, sneakers, botas</p>
            <label for="shoes-upload" class="file-label" id="shoes-label">📤 Subir Zapatos</label>
            <input type="file" id="shoes-upload" class="file-input" accept="image/*" multiple />
            <div id="shoes-preview" class="preview-area"></div>
          </div>
        </div>

        <div id="combinationsDisplay" class="combinations-info hidden">
          <div class="combinations-formula" id="combinationsFormula">1 × 1 × 1 = 1 combinación posible</div>
          <div class="combinations-result" id="combinationsResult">Se mostrarán 1 recomendación</div>
        </div>

        <div class="card mt-2" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(34, 197, 94, 0.05));">
          <h3 class="mb-2">🚀 ¡Genera tus Recomendaciones!</h3>
          <p class="mb-2" style="opacity: 0.8;">Nuestra IA analizará todas las combinaciones posibles</p>
          <div class="notification info hidden" id="processingTimer">⏱️ Procesando... <span id="timerDisplay">0.0s</span></div>
          <button class="btn btn-success mt-2" onclick="getRecommendation()" id="generateBtn" disabled>
            <i class="fas fa-magic"></i>Sube al menos 1 prenda de cada tipo
          </button>
        </div>

        <div id="result" class="hidden mt-2"></div>
      </div>
    </div>
  </section>

  <script>
    // ============================================
    // CONFIGURACIÓN Y VARIABLES GLOBALES
    // ============================================
    const CONFIG = {
      GOOGLE_CLIENT_ID: "326940877598-ko13n1qcqkkugkoo6gu2n1avs46al09p.apps.googleusercontent.com",
      LIMITS: { 
        tops: { min: 1, max: 3 }, 
        bottoms: { min: 1, max: 3 }, 
        shoes: { min: 1, max: 5 } 
      },
      CLOSET_MAX_TOTAL: 15,
      OCCASIONS: ['casual', 'oficina', 'deportivo', 'formal', 'matrimonio']
    };

    let isLoggedIn = false;
    let currentUser = null;
    let closetMode = false;
    let selectedOccasion = '';
    let uploadedFiles = { tops: [], bottoms: [], shoes: [] };
    let uploadedImages = { tops: [], bottoms: [], shoes: [] };
    let closetItems = { tops: [], bottoms: [], shoes: [] };
    let selectedClosetItems = { tops: [], bottoms: [], shoes: [] };
    let currentResults = [];
    let recommendationCache = new Map(); // Cache por (combination_id, occasion)

    // ============================================
    // GOOGLE AUTH REAL - CALLBACK FUNCTION
    // ============================================
    window.handleCredentialResponse = function(response) {
      try {
        console.log('Google Auth callback received:', response);
        
        const responsePayload = decodeJwtResponse(response.credential);
        console.log('Decoded user data:', responsePayload);
        
        currentUser = {
          email: responsePayload.email,
          name: responsePayload.name,
          picture: responsePayload.picture,
          sub: responsePayload.sub
        };
        
        isLoggedIn = true;
        updateAuthUI();
        
        document.getElementById('welcomeSection').classList.remove('hidden');
        document.getElementById('closetQuestion').classList.remove('hidden');
        document.getElementById('closetQuestion').scrollIntoView({ behavior: 'smooth', block: 'center' });
        showNotification('¡Bienvenido a NoShopiA!', 'success');
        
      } catch (error) {
        console.error('Error processing Google Auth:', error);
        showNotification('Error en autenticación. Intenta nuevamente.', 'error');
      }
    };

    function decodeJwtResponse(token) {
      const base64Url = token.split('.')[1];
      const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      const jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
      }).join(''));
      return JSON.parse(jsonPayload);
    }

    // ============================================
    // FUNCIONES DE MODO
    // ============================================
    window.enableCloset = function() {
      closetMode = true;
      updateModeIndicator('Modo Closet Digital (máx 15 prendas)', true);
      
      // Generar datos simulados para el closet
      generateMockClosetData();
      
      document.getElementById('closetQuestion').classList.add('hidden');
      document.getElementById('closetSelection').classList.remove('hidden');
      document.getElementById('occasionSelector').classList.remove('hidden');
      
      renderClosetSelection();
      showNotification('Modo Closet activado - Selecciona prendas de tu closet', 'success');
    };

    window.useDirectMode = function() {
      closetMode = false;
      updateModeIndicator('Modo Recomendaciones Rápidas (3-3-5)', false);
      
      document.getElementById('closetQuestion').classList.add('hidden');
      document.getElementById('occasionSelector').classList.remove('hidden');
      document.getElementById('uploadArea').classList.remove('hidden');
      document.getElementById('countersDisplay').classList.remove('hidden');
      
      updateCounters();
      showNotification('Modo Recomendaciones Directas activado', 'info');
    };

    // ============================================
    // GENERACIÓN DE DATOS MOCK PARA CLOSET
    // ============================================
    function generateMockClosetData() {
      // Generar URLs de imágenes simuladas
      const generateImageUrl = (type, index) => {
        const colors = ['ff6b6b', '4ecdc4', 'ffe66d', '95e1d3', 'f8b500'];
        const color = colors[index % colors.length];
        return `https://via.placeholder.com/200x200/${color}/ffffff?text=${type[0].toUpperCase()}${index + 1}`;
      };

      closetItems = {
        tops: Array(5).fill().map((_, i) => generateImageUrl('top', i)),
        bottoms: Array(4).fill().map((_, i) => generateImageUrl('bottom', i)),
        shoes: Array(6).fill().map((_, i) => generateImageUrl('shoe', i))
      };
    }

    function renderClosetSelection() {
      ['tops', 'bottoms', 'shoes'].forEach(type => {
        const container = document.getElementById(`closet${type.charAt(0).toUpperCase() + type.slice(1)}Selection`);
        container.innerHTML = '';
        
        closetItems[type].forEach((image, index) => {
          const item = document.createElement('div');
          item.className = 'closet-item';
          item.dataset.type = type;
          item.dataset.index = index;
          item.innerHTML = `
            <img src="${image}" alt="${type} ${index + 1}">
            <div style="text-align: center; margin-top: 0.5rem; font-size: 0.8rem;">${type.charAt(0).toUpperCase() + type.slice(1)} ${index + 1}</div>
          `;
          container.appendChild(item);
        });
      });
    }

    // ============================================
    // GESTIÓN DE SELECCIÓN EN CLOSET
    // ============================================
    document.addEventListener('click', (e) => {
      // Selección de items del closet
      if (e.target.closest('.closet-item')) {
        const item = e.target.closest('.closet-item');
        const type = item.dataset.type;
        const index = parseInt(item.dataset.index);
        
        // Toggle selección
        if (item.classList.contains('selected')) {
          item.classList.remove('selected');
          const badge = item.querySelector('.selection-badge');
          if (badge) badge.remove();
          
          // Remover de selección
          const selectedIndex = selectedClosetItems[type].indexOf(index);
          if (selectedIndex > -1) {
            selectedClosetItems[type].splice(selectedIndex, 1);
          }
        } else {
          // Validar límites
          const currentCount = selectedClosetItems[type].length;
          const maxAllowed = CONFIG.LIMITS[type].max;
          
          if (currentCount >= maxAllowed) {
            showNotification(`Máximo ${maxAllowed} ${type} permitidos`, 'error');
            return;
          }
          
          item.classList.add('selected');
          selectedClosetItems[type].push(index);
          
          // Añadir badge con número de selección
          const badge = document.createElement('div');
          badge.className = 'selection-badge';
          badge.textContent = selectedClosetItems[type].length;
          item.appendChild(badge);
        }
        
        updateClosetSelection();
        return;
      }

      // Selección de ocasión
      if (e.target.matches('[data-occasion]') || e.target.closest('[data-occasion]')) {
        const btn = e.target.closest('[data-occasion]') || e.target;
        document.querySelectorAll('[data-occasion]').forEach(b => {
          b.classList.remove('selected');
          b.style.borderColor = '';
          b.style.background = '';
        });
        
        btn.classList.add('selected');
        btn.style.borderColor = 'var(--success)';
        btn.style.background = 'rgba(16, 185, 129, 0.1)';
        
        const newOccasion = btn.dataset.occasion;
        const occasionChanged = selectedOccasion && selectedOccasion !== newOccasion;
        selectedOccasion = newOccasion;
        
        if (occasionChanged) {
          // Invalidar cache al cambiar ocasión
          recommendationCache.clear();
          console.log('🔄 Cache invalidado por cambio de ocasión');
          
          // Si hay resultados mostrados, regenerar con nueva ocasión
          if (currentResults.length > 0) {
            showNotification(`Ocasión cambiada a ${selectedOccasion} - Regenerando scores...`, 'info');
            setTimeout(() => getRecommendation(), 500);
          }
        }
        
        if (!closetMode) {
          document.getElementById('uploadArea').classList.remove('hidden');
          document.getElementById('countersDisplay').classList.remove('hidden');
        }
        
        updateGenerateButton();
        showNotification(`Ocasión seleccionada: ${selectedOccasion}`, 'success');
        return;
      }

      // Navigation
      if (e.target.matches('[data-section]')) {
        e.preventDefault();
        const section = document.getElementById(e.target.dataset.section);
        if (section) section.scrollIntoView({ behavior: 'smooth' });
        document.querySelectorAll('.nav-pill').forEach(pill => pill.classList.remove('active'));
        e.target.classList.add('active');
      }
    });

    function updateClosetSelection() {
      // Preparar imágenes seleccionadas para recomendaciones
      uploadedImages = { tops: [], bottoms: [], shoes: [] };
      
      ['tops', 'bottoms', 'shoes'].forEach(type => {
        selectedClosetItems[type].forEach(index => {
          uploadedImages[type].push(closetItems[type][index]);
        });
      });
      
      // Mostrar área de generación si tenemos ocasión
      if (selectedOccasion) {
        document.getElementById('uploadArea').classList.remove('hidden');
        updateCombinationsDisplay();
        updateGenerateButton();
      }
    }

    // ============================================
    // GESTIÓN DE ARCHIVOS (MODO DIRECTO)
    // ============================================
    document.addEventListener('change', (e) => {
      if (e.target.matches('.file-input')) {
        const type = e.target.id.replace('-upload', '');
        handleFileUpload(type, e.target);
      }
    });

    function handleFileUpload(type, input) {
      const files = Array.from(input.files);
      const currentCount = uploadedFiles[type].length;
      const maxAllowed = CONFIG.LIMITS[type].max - currentCount;
      
      // Validar límite por tipo
      if (files.length > maxAllowed) {
        showNotification(`Solo puedes subir ${maxAllowed} ${type} más. Máximo: ${CONFIG.LIMITS[type].max}`, 'error');
        input.value = '';
        return;
      }

      // Validar límite total del closet si aplica
      if (closetMode) {
        const totalItems = getTotalClosetItems();
        const remainingSpace = CONFIG.CLOSET_MAX_TOTAL - totalItems;
        if (files.length > remainingSpace) {
          showNotification(`Solo puedes subir ${remainingSpace} prendas más. Total máximo: ${CONFIG.CLOSET_MAX_TOTAL}`, 'error');
          input.value = '';
          return;
        }
      }

      files.forEach(file => {
        const reader = new FileReader();
        reader.onload = (e) => {
          uploadedFiles[type].push(file);
          uploadedImages[type].push(e.target.result);
          updatePreview(type);
          updateCounters();
          updateCombinationsDisplay();
          updateGenerateButton();
        };
        reader.readAsDataURL(file);
      });
      
      input.value = '';
      showNotification(`${files.length} ${type} subidas correctamente`, 'success');
    }

    function updatePreview(type) {
      const preview = document.getElementById(`${type}-preview`);
      if (!preview) return;
      
      preview.innerHTML = '';
      uploadedImages[type].forEach((imageUrl, index) => {
        const container = document.createElement('div');
        container.className = 'preview-container';
        container.innerHTML = `
          <img src="${imageUrl}" class="preview-image" alt="${type} ${index + 1}">
          <button class="remove-image" onclick="removeImage('${type}', ${index})">×</button>
        `;
        preview.appendChild(container);
      });
    }

    window.removeImage = function(type, index) {
      uploadedFiles[type].splice(index, 1);
      uploadedImages[type].splice(index, 1);
      updatePreview(type);
      updateCounters();
      updateCombinationsDisplay();
      updateGenerateButton();
    };

    // ============================================
    // ACTUALIZACIÓN DE CONTADORES Y DISPLAYS
    // ============================================
    function getTotalClosetItems() {
      return closetItems.tops.length + closetItems.bottoms.length + closetItems.shoes.length;
    }

    function updateCounters() {
      if (closetMode) return; // No mostrar contadores en modo closet
      
      ['tops', 'bottoms', 'shoes'].forEach(type => {
        const counter = document.getElementById(`${type}Counter`);
        const count = uploadedImages[type].length;
        const max = CONFIG.LIMITS[type].max;
        
        counter.textContent = `${type.charAt(0).toUpperCase() + type.slice(1)}: ${count}/${max}`;
        counter.className = 'counter-item';
        
        if (count >= max) {
          counter.classList.add('counter-warning');
        } else if (count >= CONFIG.LIMITS[type].min) {
          counter.classList.add('counter-success');
        }
      });

      // Contador total (solo si es modo closet)
      const totalCounter = document.getElementById('totalCounter');
      if (totalCounter) {
        const total = getTotalClosetItems();
        totalCounter.textContent = `Total Closet: ${total}/${CONFIG.CLOSET_MAX_TOTAL}`;
        totalCounter.className = 'counter-item';
        if (total >= CONFIG.CLOSET_MAX_TOTAL) {
          totalCounter.classList.add('counter-warning');
        }
      }
    }

    function updateCombinationsDisplay() {
      const display = document.getElementById('combinationsDisplay');
      const formula = document.getElementById('combinationsFormula');
      const result = document.getElementById('combinationsResult');
      
      const topsCount = uploadedImages.tops.length;
      const bottomsCount = uploadedImages.bottoms.length;
      const shoesCount = uploadedImages.shoes.length;
      
      if (topsCount > 0 || bottomsCount > 0 || shoesCount > 0) {
        display.classList.remove('hidden');
        
        const totalCombinations = topsCount * bottomsCount * shoesCount;
        formula.textContent = `${topsCount} × ${bottomsCount} × ${shoesCount} = ${totalCombinations} combinaciones posibles`;
        
        // Aplicar regla correcta: N = min(3, total_combos)
        const maxRecommendations = Math.min(3, totalCombinations);
        
        result.textContent = `Se mostrarán las mejores ${maxRecommendations} recomendaciones`;
      } else {
        display.classList.add('hidden');
      }
    }

    function updateGenerateButton() {
      const generateBtn = document.getElementById('generateBtn');
      const topsCount = uploadedImages.tops.length;
      const bottomsCount = uploadedImages.bottoms.length;
      const shoesCount = uploadedImages.shoes.length;
      
      const hasMinimum = topsCount >= 1 && bottomsCount >= 1 && shoesCount >= 1 && selectedOccasion;
      
      if (hasMinimum) {
        const totalCombinations = topsCount * bottomsCount * shoesCount;
        // Aplicar regla correcta: N = min(3, total_combos)
        const recommendationsToShow = Math.min(3, totalCombinations);
        
        generateBtn.disabled = false;
        generateBtn.style.opacity = '1';
        generateBtn.innerHTML = `<i class="fas fa-magic"></i> Generar ${recommendationsToShow} Recomendación${recommendationsToShow > 1 ? 'es' : ''}`;
      } else {
        generateBtn.disabled = true;
        generateBtn.style.opacity = '0.6';
        
        if (!selectedOccasion) {
          generateBtn.innerHTML = '<i class="fas fa-magic"></i> Selecciona una ocasión primero';
        } else {
          generateBtn.innerHTML = '<i class="fas fa-magic"></i> Sube al menos 1 prenda de cada tipo';
        }
      }
    }

    // ============================================
    // GENERACIÓN DE RECOMENDACIONES - BACKEND REAL
    // ============================================
    window.getRecommendation = function() {
      if (!selectedOccasion) { 
        showNotification('Selecciona una ocasión primero', 'error'); 
        return; 
      }
      
      const topsCount = uploadedImages.tops.length;
      const bottomsCount = uploadedImages.bottoms.length;
      const shoesCount = uploadedImages.shoes.length;
      
      if (topsCount < 1 || bottomsCount < 1 || shoesCount < 1) {
        showNotification('Sube al menos 1 prenda de cada tipo', 'error'); 
        return; 
      }

      const processingTimer = document.getElementById('processingTimer');
      const generateBtn = document.getElementById('generateBtn');
      
      processingTimer.classList.remove('hidden');
      generateBtn.disabled = true;
      generateBtn.innerHTML = '<div class="loading"></div> Procesando con IA...';

      let startTime = Date.now();
      const timerInterval = setInterval(() => {
        document.getElementById('timerDisplay').textContent = ((Date.now() - startTime) / 1000).toFixed(1) + 's';
      }, 100);

      // Preparar FormData para envío al backend
      const formData = new FormData();
      
      // Agregar archivos de cada categoría
      uploadedFiles.tops.forEach((file, index) => {
        formData.append('tops', file);
      });
      uploadedFiles.bottoms.forEach((file, index) => {
        formData.append('bottoms', file);
      });
      uploadedFiles.shoes.forEach((file, index) => {
        formData.append('shoes', file);
      });
      
      // Agregar ocasión
      formData.append('occasion', selectedOccasion);
      
      // Llamada real al backend
      fetch('/api/recommendations', {
        method: 'POST',
        body: formData
      })
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        clearInterval(timerInterval);
        processingTimer.classList.add('hidden');
        generateBtn.disabled = false;
        generateBtn.innerHTML = '<i class="fas fa-magic"></i> Generar Otra Recomendación';
        
        console.log('✅ Respuesta del backend:', data);
        renderRecommendations(data);
      })
      .catch(error => {
        console.error('❌ Error en llamada al backend:', error);
        clearInterval(timerInterval);
        processingTimer.classList.add('hidden');
        generateBtn.disabled = false;
        generateBtn.innerHTML = '<i class="fas fa-magic"></i> Reintentar';
        
        // Fallback: usar datos mock si falla el backend
        showNotification('Error conectando al backend, usando datos de prueba', 'error');
        const totalCombinations = topsCount * bottomsCount * shoesCount;
        const maxRecommendations = Math.min(3, totalCombinations);
        showMockRecommendationsAsBackup(maxRecommendations, totalCombinations);
      });
    };

    function showMockRecommendationsAsBackup(maxRecommendations, totalCombinations) {
      // Solo como backup si falla el backend
      const mockResults = [];
      
      for (let i = 0; i < maxRecommendations; i++) {
        const topIndex = i % uploadedImages.tops.length;
        const bottomIndex = i % uploadedImages.bottoms.length; 
        const shoeIndex = i % uploadedImages.shoes.length;
        
        // Scores diferentes según ocasión
        const occasionScores = {
          'oficina': [0.94, 0.87, 0.81],
          'deportivo': [0.76, 0.84, 0.79],
          'casual': [0.89, 0.82, 0.77],
          'formal': [0.96, 0.91, 0.85],
          'matrimonio': [0.98, 0.93, 0.88]
        };
        
        const scores = occasionScores[selectedOccasion] || [0.85, 0.78, 0.72];
        const finalScore = scores[i] || (0.85 - i * 0.07);
        
        mockResults.push({
          combination_id: i + 1,
          top: { 
            index: topIndex, 
            detected_item: ['leather jacket', 'shirt', 'graphic t-shirt'][topIndex],
            formality: ['casual', 'formal', 'casual'][topIndex]
          },
          bottom: { 
            index: bottomIndex, 
            detected_item: ['shorts', 'dress pants', 'formal pants'][bottomIndex],
            formality: ['formal', 'formal', 'formal'][bottomIndex]
          },
          shoe: { 
            index: shoeIndex, 
            detected_item: ['dress shoes', 'sneakers', 'boots'][shoeIndex],
            formality: ['formal', 'casual', 'formal'][shoeIndex]
          },
          final_score: finalScore,
          occasion_match: selectedOccasion,
          scores: {
            harmony: {
              type_display: ['Monocromática', 'Complementaria', 'Tetrádica'][i % 3],
              description: ['Armonía monocromática sofisticada', 'Contraste complementario equilibrado', 'Composición tetrádica balanceada'][i % 3]
            }
          },
          style_tips: [
            'Añade texturas contrastantes para crear profundidad visual',
            'Incluye accesorios metálicos para romper la uniformidad',
            'Excelente combinación con gran potencial'
          ],
          coherence_explanation: 'Dominancia formal con toque variado - sofisticado'
        });
      }

      const mockData = {
        success: true,
        results: mockResults,
        total_combinations_possible: totalCombinations,
        total_combinations_evaluated: Math.min(10, totalCombinations),
        message: `Las mejores ${maxRecommendations} de ${totalCombinations} combinaciones están listas (modo prueba)`,
        processing_stats: { total_time: '2.5s' }
      };

      renderRecommendations(mockData);
    }

    function showMockRecommendations(maxRecommendations, totalCombinations) {
      // Generar datos mock que respetan la lógica del backend
      const mockResults = [];
      
      // Generar combinaciones específicas para asegurar variedad
      const topIndices = Array.from({length: uploadedImages.tops.length}, (_, i) => i);
      const bottomIndices = Array.from({length: uploadedImages.bottoms.length}, (_, i) => i);
      const shoeIndices = Array.from({length: uploadedImages.shoes.length}, (_, i) => i);
      
      for (let i = 0; i < maxRecommendations; i++) {
        // Usar diferentes combinaciones para cada recomendación
        const topIndex = topIndices[i % topIndices.length];
        const bottomIndex = bottomIndices[i % bottomIndices.length];
        const shoeIndex = shoeIndices[i % shoeIndices.length];
        
        // Scores variables según ocasión
        const baseScore = 0.95 - (i * 0.08); // Decrecer más gradualmente
        const occasionBonus = getOccasionBonus(selectedOccasion);
        const randomVariation = (Math.random() - 0.5) * 0.05; // Variación pequeña
        const finalScore = Math.max(0.65, Math.min(0.98, baseScore + occasionBonus + randomVariation));
        
        const detectedItems = {
          tops: ['leather jacket', 'shirt', 'graphic t-shirt'],
          bottoms: ['shorts', 'dress pants', 'formal pants'],
          shoes: ['dress shoes', 'sneakers', 'boots']
        };
        
        mockResults.push({
          combination_id: i + 1,
          top: { 
            index: topIndex, 
            detected_item: detectedItems.tops[topIndex % detectedItems.tops.length] 
          },
          bottom: { 
            index: bottomIndex, 
            detected_item: detectedItems.bottoms[bottomIndex % detectedItems.bottoms.length] 
          },
          shoe: { 
            index: shoeIndex, 
            detected_item: detectedItems.shoes[shoeIndex % detectedItems.shoes.length] 
          },
          final_score: finalScore,
          occasion_match: selectedOccasion,
          harmony_type: ['Monocromática', 'Complementaria', 'Tetrádica', 'Neutral', 'Análoga'][i % 5],
          harmony_description: [
            'Armonía monocromática sofisticada',
            'Contraste complementario equilibrado', 
            'Composición tetrádica balanceada',
            'Combinación neutral elegante',
            'Paleta análoga armoniosa'
          ][i % 5]
        });
      }

      // Guardar en cache con la ocasión actual
      const cacheKey = `${selectedOccasion}_${Date.now()}`;
      recommendationCache.set(cacheKey, mockResults);

      const mockData = {
        success: true,
        results: mockResults,
        total_combinations_possible: totalCombinations,
        total_combinations_evaluated: Math.min(10, totalCombinations),
        message: `Las mejores ${maxRecommendations} de ${totalCombinations} combinaciones están listas`,
        processing_stats: { total_time: '2.5s' }
      };

      console.log(`🎯 Generando ${maxRecommendations} recomendaciones para ocasión: ${selectedOccasion}`);
      console.log('📊 Scores generados:', mockResults.map(r => `${Math.round(r.final_score * 100)}%`).join(', '));
      
      renderRecommendations(mockData);
    }

    function getOccasionBonus(occasion) {
      const bonuses = {
        'oficina': 0.05,
        'formal': 0.04,
        'casual': 0.03,
        'deportivo': 0.02,
        'matrimonio': 0.06
      };
      return bonuses[occasion] || 0;
    }

    // ============================================
    // RENDERIZADO DE RECOMENDACIONES - FORMATO CORRECTO
    // ============================================
    function renderRecommendations(data) {
      const result = document.getElementById('result');
      const results = data.results || [];
      
      if (results.length === 0) {
        result.innerHTML = '<p style="text-align: center; color: #000000; padding: 2rem;">No se encontraron recomendaciones.</p>';
        result.classList.remove('hidden');
        return;
      }
      
      // Ordenar por final_score descendente (el backend ya debería enviarlos ordenados)
      results.sort((a, b) => (b.final_score || 0) - (a.final_score || 0));
      
      const occasionText = {
        'oficina': 'Oficina',
        'deportivo': 'Deportivo', 
        'casual': 'Casual',
        'formal': 'Formal',
        'matrimonio': 'Matrimonio'
      };
      
      let html = `
        <div style="text-align: center; margin-bottom: 2rem;">
          <h2 style="color: #000000; margin-bottom: 1rem;">🪄 Tus Recomendaciones</h2>
          <div style="background: rgba(59, 130, 246, 0.1); border-radius: 10px; padding: 1rem; margin: 1rem 0; display: inline-block;">
            <strong>📍 ${occasionText[selectedOccasion] || selectedOccasion}</strong> | 
            <strong>${data.message || `${results.length} recomendaciones generadas`}</strong>
          </div>
        </div>
      `;
      
      // Renderizar TODAS las recomendaciones del backend
      results.forEach((item, idx) => {
        const scorePercent = Math.round((item.final_score || 0) * 100);
        
        const topImage = getImageForCombination('tops', item);
        const bottomImage = getImageForCombination('bottoms', item);
        const shoeImage = getImageForCombination('shoes', item);
        
        html += `
          <div style="background: var(--background); border: 2px solid var(--border); border-radius: 20px; padding: 2rem; margin-bottom: 2rem; position: relative; box-shadow: 0 4px 15px rgba(0,0,0,0.08);">
            
            <!-- HEADER CON SCORE EN ESQUINA SUPERIOR DERECHA -->
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1.5rem;">
              <h3 style="color: #000000; margin: 0; font-size: 1.5rem; font-weight: 700;">Combinación ${idx + 1}</h3>
              <div style="background: #4F83FF; color: white; padding: 0.8rem 1.5rem; border-radius: 20px; font-weight: 800; font-size: 1.4rem; box-shadow: 0 4px 12px rgba(79, 131, 255, 0.3);">
                ${scorePercent}%
              </div>
            </div>
            
            <!-- GRID DE IMÁGENES -->
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; margin-bottom: 2rem;">
              <div style="text-align: center;">
                <div style="background: #f8fafc; border: 2px solid #e5e7eb; border-radius: 15px; padding: 1rem; min-height: 200px; display: flex; align-items: center; justify-content: center; margin-bottom: 1rem;">
                  ${topImage ? `<img src="${topImage}" style="max-width: 160px; max-height: 160px; object-fit: contain; border-radius: 10px;" alt="Superior">` : '<div style="color: #666; font-size: 3rem;">👕</div>'}
                </div>
                <div style="font-size: 0.9rem; color: #666; text-transform: uppercase; font-weight: 600;">👕 SUPERIOR</div>
                <div style="color: #000; font-weight: 600; margin: 0.5rem 0;">${item.top?.detected_item || 'Superior'}</div>
                <div style="color: #666; font-size: 0.8rem;">${item.top?.formality || 'Casual'}</div>
              </div>
              
              <div style="text-align: center;">
                <div style="background: #f8fafc; border: 2px solid #e5e7eb; border-radius: 15px; padding: 1rem; min-height: 200px; display: flex; align-items: center; justify-content: center; margin-bottom: 1rem;">
                  ${bottomImage ? `<img src="${bottomImage}" style="max-width: 160px; max-height: 160px; object-fit: contain; border-radius: 10px;" alt="Inferior">` : '<div style="color: #666; font-size: 3rem;">👖</div>'}
                </div>
                <div style="font-size: 0.9rem; color: #666; text-transform: uppercase; font-weight: 600;">👖 INFERIOR</div>
                <div style="color: #000; font-weight: 600; margin: 0.5rem 0;">${item.bottom?.detected_item || 'Inferior'}</div>
                <div style="color: #666; font-size: 0.8rem;">${item.bottom?.formality || 'Semiformal'}</div>
              </div>
              
              <div style="text-align: center;">
                <div style="background: #f8fafc; border: 2px solid #e5e7eb; border-radius: 15px; padding: 1rem; min-height: 200px; display: flex; align-items: center; justify-content: center; margin-bottom: 1rem;">
                  ${shoeImage ? `<img src="${shoeImage}" style="max-width: 160px; max-height: 160px; object-fit: contain; border-radius: 10px;" alt="Calzado">` : '<div style="color: #666; font-size: 3rem;">👠</div>'}
                </div>
                <div style="font-size: 0.9rem; color: #666; text-transform: uppercase; font-weight: 600;">👠 CALZADO</div>
                <div style="color: #000; font-weight: 600; margin: 0.5rem 0;">${item.shoe?.detected_item || 'Calzado'}</div>
                <div style="color: #666; font-size: 0.8rem;">${item.shoe?.formality || 'Casual'}</div>
              </div>
            </div>
            
            <!-- INFORMACIÓN DE OCASIÓN, ARMONÍA Y COHERENCIA -->
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
              <div style="text-align: center; background: #f0f9ff; padding: 1rem; border-radius: 10px;">
                <div style="font-weight: 600; color: #0369a1; font-size: 0.8rem; margin-bottom: 0.5rem;">OCASIÓN</div>
                <div style="color: #000; font-weight: 600;">${occasionText[item.occasion_match] || item.occasion_match || selectedOccasion}</div>
              </div>
              <div style="text-align: center; background: #f0fdf4; padding: 1rem; border-radius: 10px;">
                <div style="font-weight: 600; color: #15803d; font-size: 0.8rem; margin-bottom: 0.5rem;">ARMONÍA</div>
                <div style="color: #000; font-weight: 600;">${item.scores?.harmony?.type_display || item.harmony_type || 'Equilibrada'}</div>
              </div>
              <div style="text-align: center; background: #fef3f2; padding: 1rem; border-radius: 10px;">
                <div style="font-weight: 600; color: #dc2626; font-size: 0.8rem; margin-bottom: 0.5rem;">COHERENCIA</div>
                <div style="color: #000; font-weight: 600;">${scorePercent}%</div>
              </div>
            </div>
            
            <!-- DESCRIPCIÓN DE ARMONÍA -->
            <div style="background: #f8fafc; border-left: 4px solid #4F83FF; padding: 1rem; margin-bottom: 1.5rem; border-radius: 0 10px 10px 0;">
              <div style="color: #4F83FF; font-weight: 600; margin-bottom: 0.5rem;">💡 ${item.scores?.harmony?.description || item.harmony_description || 'Combinación balanceada'}</div>
            </div>
            
            <!-- TIPS DE ESTILO -->
            ${item.style_tips && item.style_tips.length > 0 ? `
            <div style="background: #fffbeb; border-radius: 10px; padding: 1.5rem;">
              <div style="color: #d97706; font-weight: 600; margin-bottom: 1rem;">💡 Tipo de Estilo:</div>
              <ul style="list-style: none; padding: 0; margin: 0;">
                ${item.style_tips.slice(0, 3).map(tip => `
                  <li style="padding: 0.3rem 0; color: #000; display: flex; align-items: flex-start;">
                    <span style="color: #d97706; margin-right: 0.5rem;">•</span>
                    <span>${tip}</span>
                  </li>
                `).join('')}
              </ul>
            </div>
            ` : ''}
            
          </div>
        `;
      });
      
      result.innerHTML = html;
      result.classList.remove('hidden');
      
      // Guardar resultados globalmente
      currentResults = results;
      
      setTimeout(() => {
        result.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }, 200);
      
      showNotification(`${results.length} recomendaciones generadas para ${selectedOccasion}`, 'success');
      console.log(`✅ Renderizadas ${results.length} recomendaciones para ocasión: ${selectedOccasion}`);
    }

    // ============================================
    // FUNCIONES AUXILIARES
    // ============================================
    function updateModeIndicator(text, isCloset) {
      const indicator = document.getElementById('modeIndicator');
      indicator.textContent = text;
      indicator.style.display = 'block';
      indicator.classList.toggle('closet', isCloset);
    }

    function updateAuthUI() {
      const googleSignIn = document.getElementById('googleSignInBtn');
      const heroAuth = document.getElementById('heroGoogleAuth');
      const userInfo = document.getElementById('userInfo');
      
      if (isLoggedIn && currentUser) {
        googleSignIn.style.display = 'none';
        heroAuth.style.display = 'none';
        userInfo.style.display = 'flex';
        document.getElementById('userName').textContent = currentUser.name;
        document.getElementById('userAvatar').src = currentUser.picture;
      } else {
        googleSignIn.style.display = 'block';
        heroAuth.style.display = 'flex';
        userInfo.style.display = 'none';
      }
    }

    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      document.body.appendChild(notification);
      setTimeout(() => notification.remove(), 4000);
    }

    // Modal functions
    window.showLogoutModal = function() {
      document.getElementById('logoutModal').style.display = 'flex';
    };

    window.closeLogoutModal = function() {
      document.getElementById('logoutModal').style.display = 'none';
    };

    window.confirmLogout = function() {
      closeLogoutModal();
      isLoggedIn = false; 
      currentUser = null; 
      closetMode = false; 
      selectedOccasion = '';
      uploadedFiles = { tops: [], bottoms: [], shoes: [] };
      uploadedImages = { tops: [], bottoms: [], shoes: [] };
      closetItems = { tops: [], bottoms: [], shoes: [] };
      selectedClosetItems = { tops: [], bottoms: [], shoes: [] };
      currentResults = [];
      recommendationCache.clear();
      
      updateAuthUI();
      
      ['welcomeSection', 'closetQuestion', 'closetSelection', 'occasionSelector', 'uploadArea'].forEach(id => {
        document.getElementById(id).classList.add('hidden');
      });
      
      document.getElementById('modeIndicator').style.display = 'none';
      showNotification('Sesión cerrada exitosamente', 'info');
      
      if (window.google && google.accounts) {
        google.accounts.id.disableAutoSelect();
      }
    };

    // ============================================
    // INICIALIZACIÓN
    // ============================================
    document.addEventListener('DOMContentLoaded', () => {
      console.log('Initializing NoShopiA with corrected recommendation system...');
      updateAuthUI();
      
      console.log('✅ NoShopiA loaded with fixes:');
      console.log('- Tope de recomendaciones: 1/2/3 según combinaciones');
      console.log('- Cache invalidation al cambiar ocasión');
      console.log('- Límites: 3-3-5 para directo, 15 total closet');
      console.log('- CTA dinámico según combinaciones');
      console.log('- Contadores y validaciones correctas');
    });
  </script>
</body>
</html>
