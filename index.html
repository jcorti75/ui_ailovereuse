<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NoShopiA - Reutiliza tu ropa con IA</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary: #3b82f6; --text-primary: #1f2937; --text-secondary: #6b7280; --background: #ffffff;
      --border: #e5e7eb; --accent: #10b981; --warning: #f59e0b; --error: #ef4444; --success: #10b981; --gold: #fbbf24;
    }
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Poppins', -apple-system, BlinkMacSystemFont, sans-serif; line-height: 1.6; overflow-x: hidden;
      background: var(--background); color: #000000; min-height: 100vh; font-size: 1.2em;
    }
    .container { max-width: 1200px; margin: 0 auto; padding: 0 2rem; }
    .section { padding: 6rem 5%; position: relative; z-index: 2; background: var(--background); }
    .section-title { text-align: center; margin-bottom: 4rem; }
    .section-title h2 { font-size: 2.5rem; font-weight: 800; margin-bottom: 1rem; color: #000000; }
    .section-subtitle { font-size: 1.2rem; max-width: 600px; margin: 0 auto; color: #000000; opacity: 0.8; }

    /* Header & Navigation */
    header {
      position: fixed; top: 0; width: 100%; padding: 1rem 5%; background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px); border-bottom: 1px solid var(--border); z-index: 1000; transition: all 0.3s ease;
    }
    nav { display: flex; justify-content: space-between; align-items: center; max-width: 1200px; margin: 0 auto; }
    .logo { font-size: 3rem; font-weight: 900; display: flex; align-items: center; letter-spacing: 1px; }
    .logo-no { color: #ef4444; } .logo-shop { color: #000000; } .logo-i, .logo-a { color: #22c55e; }
    
    .nav-pills {
      display: flex; background: rgba(59, 130, 246, 0.1); padding: 0.5rem; border-radius: 50px; gap: 0.5rem;
    }
    .nav-pill {
      padding: 0.7rem 1.5rem; border-radius: 25px; color: #000000; text-decoration: none; font-weight: 500;
      transition: all 0.3s ease; display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem;
    }
    .nav-pill:hover, .nav-pill.active { background: rgba(59, 130, 246, 0.2); transform: translateY(-2px); }

    .mobile-menu-toggle {
      display: none; background: none; border: none; font-size: 1.5rem; color: var(--primary); cursor: pointer;
    }
    
    .auth-container { display: flex; align-items: center; gap: 1rem; margin-left: 1rem; }
    .user-info { display: none; align-items: center; gap: 1rem; }
    .user-info.show { display: flex; }
    .user-avatar { width: 35px; height: 35px; border-radius: 50%; border: 2px solid var(--primary); }
    .logout-btn {
      background: transparent; border: 1px solid var(--primary); color: var(--primary); padding: 0.5rem 1rem;
      border-radius: 20px; cursor: pointer; font-size: 0.9rem; transition: all 0.3s ease;
    }
    .logout-btn:hover { background: var(--primary); color: white; }

    /* BOT√ìN DE LOGIN AZUL PERSONALIZADO */
    .custom-google-btn {
      background: linear-gradient(135deg, var(--primary), #1d4ed8);
      color: white;
      border: none;
      padding: 0.8rem 1.5rem;
      border-radius: 25px;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
      text-decoration: none;
      outline: none;
      font-family: inherit;
    }
    .custom-google-btn:hover {
      background: linear-gradient(135deg, #2563eb, #1e40af);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
    }
    .custom-google-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

    .btn {
      padding: 1.2rem 3rem; border: none; border-radius: 50px; font-weight: 600; font-size: 1.1rem;
      cursor: pointer; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 0.8rem;
      text-decoration: none; outline: none; box-sizing: border-box;
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--primary), #1d4ed8); color: white;
      box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
    }
    .btn-primary:hover { transform: translateY(-3px); box-shadow: 0 15px 40px rgba(59, 130, 246, 0.4); }
    .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
    .btn-success {
      background: linear-gradient(135deg, var(--success), #059669); color: white;
      box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);
    }
    .btn-success:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 15px 40px rgba(16, 185, 129, 0.4); }

    .hero {
      min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center;
      text-align: center; position: relative; z-index: 2; padding: 6rem 2rem 4rem; background: var(--background);
    }
    .hero h1 { font-size: clamp(2rem, 5vw, 4rem); font-weight: 800; margin-bottom: 1rem; color: #000000; line-height: 1.2; }
    .hero-subtitle { font-size: 1.3rem; margin-bottom: 0.5rem; font-weight: 600; color: #000000; }

    .grid { display: grid; gap: 2rem; }
    .grid-2 { grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); }
    .grid-3 { grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); }
    .grid-4 { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
    .grid-5 { grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); }

    .card {
      background: var(--background); border-radius: 25px; padding: 3rem 2rem; border: 1px solid var(--border);
      transition: all 0.3s ease; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .card:hover { transform: translateY(-10px); box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15); }
    .card-compact { padding: 2rem 1.5rem; }
    .card-icon { font-size: 3rem; margin-bottom: 1rem; color: var(--primary); }

    .form-section {
      background: rgba(59, 130, 246, 0.05); border: 2px solid rgba(59, 130, 246, 0.2);
      border-radius: 20px; padding: 3rem 2rem; margin: 2rem 0; animation: fadeInUp 0.6s ease-out;
    }
    .form-options { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
    .form-option {
      background: var(--background); border: 2px solid var(--border); border-radius: 15px; padding: 1rem 0.5rem;
      cursor: pointer; transition: all 0.3s ease; display: flex; flex-direction: column; align-items: center;
      gap: 0.5rem; font-size: 0.9rem; font-weight: 500; color: #000000; text-align: center;
      min-height: 80px; justify-content: center;
    }
    .form-option:hover { transform: translateY(-3px); border-color: var(--primary); background: rgba(59, 130, 246, 0.1); }
    .form-option.selected {
      border-color: var(--primary); background: rgba(59, 130, 246, 0.15); transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(59, 130, 246, 0.3);
    }

    /* CLOSET INTELIGENTE REAL */
    .intelligent-closet {
      background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(16, 185, 129, 0.1));
      border: 2px solid rgba(251, 191, 36, 0.3); border-radius: 25px; padding: 2rem; margin: 2rem 0;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    .closet-header {
      display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;
      background: linear-gradient(135deg, var(--gold), #f59e0b); color: #000;
      padding: 1.5rem; border-radius: 15px; font-weight: 700;
    }
    .ai-detection-status {
      background: rgba(16, 185, 129, 0.1); border: 2px solid var(--success); border-radius: 15px;
      padding: 1rem; margin-bottom: 2rem; text-align: center; display: none;
    }
    .ai-detection-status.active { display: block; animation: pulse 2s infinite; }
    .ai-detection-text { font-weight: 600; color: var(--success); margin-bottom: 0.5rem; }
    .ai-progress { background: rgba(16, 185, 129, 0.2); border-radius: 10px; height: 8px; overflow: hidden; }
    .ai-progress-bar { background: var(--success); height: 100%; transition: width 2s ease; width: 0%; }

    .smart-upload-area {
      background: rgba(59, 130, 246, 0.05); border: 3px dashed var(--primary); border-radius: 20px;
      padding: 3rem; text-align: center; cursor: pointer; transition: all 0.3s ease; margin-bottom: 2rem;
    }
    .smart-upload-area:hover { background: rgba(59, 130, 246, 0.1); border-color: var(--success); }
    .smart-upload-area.dragover { background: rgba(16, 185, 129, 0.1); border-color: var(--success); transform: scale(1.02); }

    .closet-navigation {
      display: flex; background: rgba(255, 255, 255, 0.7); border-radius: 15px; padding: 0.5rem;
      gap: 0.5rem; margin-bottom: 2rem; backdrop-filter: blur(10px);
    }
    .closet-nav-item {
      flex: 1; padding: 1rem; background: transparent; border: none; border-radius: 10px;
      cursor: pointer; font-weight: 600; color: #000; transition: all 0.3s ease; position: relative;
    }
    .closet-nav-item.active {
      background: var(--background); color: var(--primary); box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transform: translateY(-2px);
    }
    .nav-badge {
      position: absolute; top: -5px; right: -5px; background: var(--gold); color: #000;
      border-radius: 50%; width: 25px; height: 25px; font-size: 0.8rem; font-weight: 700;
      display: flex; align-items: center; justify-content: center;
    }

    .intelligent-categories {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;
    }
    .smart-category {
      background: var(--background); border: 2px solid var(--border); border-radius: 20px;
      padding: 1.5rem; transition: all 0.3s ease; cursor: pointer; position: relative; overflow: hidden;
    }
    .smart-category:hover { transform: translateY(-5px); box-shadow: 0 15px 40px rgba(0,0,0,0.1); }
    .smart-category.has-items { 
      border-color: var(--success); background: linear-gradient(135deg, rgba(16, 185, 129, 0.05), rgba(59, 130, 246, 0.05));
    }
    .smart-category.auto-detected { 
      border-color: var(--gold); background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(16, 185, 129, 0.05));
    }
    .smart-category.auto-detected::before {
      content: "üß† IA"; position: absolute; top: 10px; right: 10px; 
      background: var(--gold); color: #000; padding: 0.2rem 0.5rem; border-radius: 10px;
      font-size: 0.7rem; font-weight: 700;
    }

    .category-header {
      display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;
    }
    .category-icon {
      font-size: 2.5rem; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center;
      background: linear-gradient(135deg, var(--primary), #1d4ed8); color: white; border-radius: 15px;
      box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
    }
    .category-info h4 { margin: 0; font-size: 1.2rem; font-weight: 700; color: #000; }
    .category-info p { margin: 0; font-size: 0.9rem; opacity: 0.7; }
    .ai-confidence {
      background: var(--gold); color: #000; padding: 0.3rem 0.8rem; border-radius: 15px;
      font-weight: 700; font-size: 0.8rem; margin-top: 0.5rem; display: inline-block;
    }

    .smart-items-grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 1rem; margin-top: 1rem;
    }
    .smart-item {
      position: relative; background: #f8fafc; border-radius: 12px; overflow: hidden;
      aspect-ratio: 1; cursor: pointer; transition: all 0.3s ease; border: 2px solid transparent;
    }
    .smart-item:hover { transform: scale(1.05); border-color: var(--primary); }
    .smart-item.selected { border-color: var(--success); background: rgba(16, 185, 129, 0.1); }
    .smart-item img { width: 100%; height: 100%; object-fit: cover; }
    .item-controls {
      position: absolute; top: 5px; right: 5px; display: flex; gap: 2px;
    }
    .item-btn {
      background: rgba(0,0,0,0.7); color: white; border: none; border-radius: 50%;
      width: 25px; height: 25px; font-size: 11px; cursor: pointer;
      display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;
    }
    .item-btn:hover { background: var(--error); }
    .item-btn.select { background: var(--success); }
    .item-btn.select:hover { background: var(--primary); }

    .smart-selection-panel {
      background: rgba(59, 130, 246, 0.05); border-radius: 20px; padding: 2rem; margin-top: 2rem;
    }
    .selection-summary {
      display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 2rem;
    }
    .selection-category {
      background: var(--background); border-radius: 15px; padding: 1.5rem; text-align: center;
      border: 2px solid var(--border); transition: all 0.3s ease;
    }
    .selection-category.has-selection { border-color: var(--success); background: rgba(16, 185, 129, 0.05); }
    .selection-count {
      font-size: 2rem; font-weight: 900; color: var(--primary); margin-bottom: 0.5rem; display: block;
    }
    .selection-label { font-weight: 600; color: #000; opacity: 0.8; }
    .selected-items-preview {
      display: flex; gap: 0.5rem; margin-top: 1rem; justify-content: center;
    }
    .mini-preview {
      width: 40px; height: 40px; border-radius: 8px; object-fit: cover;
      border: 2px solid var(--success); opacity: 0.9;
    }

    .upload-area {
      background: rgba(59, 130, 246, 0.02); border: 2px dashed var(--border);
      border-radius: 25px; padding: 4rem 2rem; margin: 2rem 0;
    }
    .file-input { display: none; }
    .file-label {
      display: block; padding: 1rem 2rem; background: var(--primary); border-radius: 25px;
      color: white; font-weight: 600; cursor: pointer; transition: all 0.3s ease; margin-top: 1rem;
    }
    .file-label:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(59, 130, 246, 0.3); }
    .preview-area { margin-top: 1rem; display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center; }
    .preview-container { position: relative; display: inline-block; }
    .preview-image {
      width: 120px; height: 120px; object-fit: cover; border-radius: 15px;
      border: 2px solid var(--primary); position: relative;
    }
    .remove-image {
      position: absolute; top: -8px; right: -8px; background: #ef4444; color: white; border: none;
      border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 12px;
      display: flex; align-items: center; justify-content: center;
    }

    .notification {
      position: fixed; top: 20px; right: 20px; padding: 1rem 2rem; border-radius: 15px; color: white;
      font-weight: 600; z-index: 10000; max-width: 350px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      animation: slideInRight 0.3s ease;
    }
    .notification.success { background: linear-gradient(135deg, #10b981, #059669); }
    .notification.error { background: linear-gradient(135deg, #ef4444, #dc2626); }
    .notification.info { background: linear-gradient(135deg, var(--primary), #1d4ed8); }

    .counter-display {
      background: rgba(59, 130, 246, 0.1); border-radius: 15px; padding: 1rem;
      margin: 1rem 0; text-align: center; font-weight: 600;
    }
    .counter-item {
      display: inline-block; margin: 0 1rem; padding: 0.5rem 1rem;
      background: var(--background); border-radius: 10px; border: 1px solid var(--border);
    }
    .counter-success { background: rgba(16, 185, 129, 0.1); border-color: var(--success); color: var(--success); }

    .combinations-info {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(16, 185, 129, 0.1));
      border-radius: 15px; padding: 1.5rem; margin: 1rem 0; text-align: center;
    }
    .combinations-formula { font-size: 1.2rem; font-weight: 700; color: var(--primary); margin-bottom: 0.5rem; }
    .combinations-result { font-size: 1rem; color: #000000; opacity: 0.8; }

    .loading {
      display: inline-block; width: 20px; height: 20px; border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%; border-top-color: #ffffff; animation: spin 1s ease-in-out infinite;
    }

    .hidden { display: none !important; }
    .text-center { text-align: center; }
    .mb-2 { margin-bottom: 2rem; }

    @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Responsive */
    @media (max-width: 768px) {
      .nav-pills { display: none; }
      .mobile-menu-toggle { display: block; }
      .logo { font-size: 2rem; }
      .section { padding: 4rem 3%; }
      .form-options { grid-template-columns: 1fr; }
      .grid-2, .grid-3 { grid-template-columns: 1fr; }
      .grid-4, .grid-5 { grid-template-columns: repeat(2, 1fr); }
      .hero { padding: 4rem 1rem 2rem; }
      .card { padding: 2rem 1rem; }
      .intelligent-categories { grid-template-columns: 1fr; }
      .closet-navigation { flex-direction: column; }
      .selection-summary { grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <!-- Header -->
  <header>
    <nav>
      <div class="logo">
        <span class="logo-no">No</span><span class="logo-shop">shop</span><span class="logo-i">i</span><span class="logo-a">A</span>
      </div>
      
      <div style="display: flex; align-items: center;">
        <div class="nav-pills">
          <a href="#inicio" class="nav-pill active" data-section="inicio">üè† Inicio</a>
          <a href="#impacto" class="nav-pill" data-section="impacto">üåç Impacto</a>
          <a href="#precios" class="nav-pill" data-section="precios">$ Precios</a>
          <a href="#funcionamiento" class="nav-pill" data-section="funcionamiento">‚öôÔ∏è C√≥mo funciona</a>
          <a href="#equipo" class="nav-pill" data-section="equipo">üë• Equipo</a>
        </div>
        
        <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">
          <i class="fas fa-bars"></i>
        </button>

        <div class="auth-container">
          <!-- Bot√≥n personalizado de login AZUL -->
          <div id="googleLoginContainer" style="display: block;">
            <div id="g_id_onload"
                 data-client_id="326940877598-ko13n1qcqkkugkoo6gu2n1avs46al09p.apps.googleusercontent.com"
                 data-context="signin"
                 data-ux_mode="popup"
                 data-callback="handleCredentialResponse"
                 data-auto_prompt="false"
                 style="display: none;">
            </div>
            <div class="g_id_signin" style="display: none;"></div>
            
            <button id="customGoogleLoginBtn" class="custom-google-btn" onclick="triggerGoogleLogin()">
              <i class="fab fa-google" style="margin-right: 8px;"></i>
              Iniciar Sesi√≥n
            </button>
          </div>

          <!-- Info del usuario -->
          <div class="user-info" id="userInfo" style="display: none;">
            <img class="user-avatar" id="userAvatar" alt="Usuario"/>
            <span id="userName" style="color: #000000; font-weight: 500;"></span>
            <button class="logout-btn" onclick="logout()">Salir</button>
          </div>
        </div>
      </div>
    </nav>
  </header>

  <!-- Hero Section -->
  <section id="inicio" class="hero">
    <div style="max-width: 900px;">
      <span style="font-size: 4rem; margin-bottom: 1rem; display: block;">üö´üõçÔ∏èüëï</span>
      <h1>Reutiliza tu ropa con IA y minimiza tu Impacto Ambiental</h1>
      <p class="hero-subtitle">¬øTardas mucho eligiendo qu√© ponerte cada ma√±ana?</p>
      <p style="font-size: 1.1rem; color: #000000; opacity: 0.8; margin-bottom: 3rem; max-width: 700px; margin-left: auto; margin-right: auto;">
        Descubre combinaciones √∫nicas con tu ropa actual gracias a nuestra inteligencia artificial. Sin estr√©s, sin p√©rdida de tiempo, solo outfits perfectos que cuidan el planeta.
      </p>

      <div class="grid grid-3" style="max-width: 800px;">
        <div class="card card-compact">
          <span style="font-size: 2.5rem; font-weight: 900; color: var(--primary); margin-bottom: 0.5rem; display: block;">15min</span>
          <span style="color: #000000; opacity: 0.7;">Ahorrados cada ma√±ana</span>
        </div>
        <div class="card card-compact">
          <span style="font-size: 2.5rem; font-weight: 900; color: var(--primary); margin-bottom: 0.5rem; display: block;">10s</span>
          <span style="color: #000000; opacity: 0.7;">Para generar outfit</span>
        </div>
        <div class="card card-compact">
          <span style="font-size: 2.5rem; font-weight: 900; color: var(--primary); margin-bottom: 0.5rem; display: block;">25kg</span>
          <span style="color: #000000; opacity: 0.7;">CO‚ÇÇ reducido</span>
        </div>
      </div>
    </div>
  </section>

  <!-- Upload Section CON CLOSET INTELIGENTE REAL -->
  <section id="upload" class="section" style="background: rgba(249, 250, 251, 0.5);">
    <div class="container">
      <div class="section-title">
        <h2>‚ú® Tu Guardarropa Digital Personalizado</h2>
        <p class="section-subtitle">Sube fotos de la ropa que ya tienes y descubre combinaciones incre√≠bles</p>
      </div>

      <!-- Welcome Section -->
      <div id="welcomeSection" class="form-section hidden" style="background: rgba(34, 197, 94, 0.05); border-color: rgba(34, 197, 94, 0.2);">
        <h3 class="text-center mb-2">üéâ ¬°Bienvenido a NoShopiA!</h3>
        <p class="text-center mb-2" style="opacity: 0.8;">Tu perfil ha sido creado exitosamente. Para darte mejores recomendaciones, necesitamos conocerte un poco m√°s.</p>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; text-align: center;">
          <div style="background: rgba(255, 255, 255, 0.1); padding: 1rem; border-radius: 10px;">
            <span style="font-size: 1.5rem; font-weight: 700; display: block;" id="visitCounter">1</span>
            <span>Visitas</span>
          </div>
          <div style="background: rgba(255, 255, 255, 0.1); padding: 1rem; border-radius: 10px;">
            <span style="font-size: 1.5rem; font-weight: 700; display: block;" id="recommendationCounter">0</span>
            <span>Recomendaciones</span>
          </div>
          <div style="background: rgba(255, 255, 255, 0.1); padding: 1rem; border-radius: 10px;">
            <span style="font-size: 1.5rem; font-weight: 700; display: block;" id="outfitCounter">0</span>
            <span>Outfits Guardados</span>
          </div>
        </div>
      </div>

      <!-- Profile Form -->
      <div id="profileForm" class="form-section hidden">
        <h3 class="text-center mb-2">üë§ Completa tu Perfil (Solo una vez)</h3>
        <p class="text-center mb-2" style="opacity: 0.8;">Para personalizar mejor tus recomendaciones futuras</p>

        <div style="max-width: 600px; margin: 0 auto;">
          <div class="profile-field">
            <label style="display: block; font-weight: 600; margin-bottom: 1rem; font-size: 1.1rem;">Color de piel:</label>
            <div class="form-options" id="skinColorOptions">
              <button type="button" class="form-option" data-field="skin_color" data-value="claro">
                <div style="background: #F5DEB3; width: 30px; height: 30px; border-radius: 50%; margin: 0 auto 0.5rem;"></div>
                Claro
              </button>
              <button type="button" class="form-option" data-field="skin_color" data-value="medio">
                <div style="background: #DEB887; width: 30px; height: 30px; border-radius: 50%; margin: 0 auto 0.5rem;"></div>
                Medio
              </button>
              <button type="button" class="form-option" data-field="skin_color" data-value="oscuro">
                <div style="background: #8B4513; width: 30px; height: 30px; border-radius: 50%; margin: 0 auto 0.5rem;"></div>
                Oscuro
              </button>
            </div>
          </div>

          <div class="profile-field">
            <label style="display: block; font-weight: 600; margin-bottom: 1rem; font-size: 1.1rem;">Rango de edad:</label>
            <div class="form-options" id="ageRangeOptions">
              <button type="button" class="form-option" data-field="age_range" data-value="menor_18">
                <i class="fas fa-child" style="font-size: 1.5rem; color: var(--primary);"></i>
                Menor 18
              </button>
              <button type="button" class="form-option" data-field="age_range" data-value="18-24">
                <i class="fas fa-user-graduate" style="font-size: 1.5rem; color: var(--primary);"></i>
                18-24
              </button>
              <button type="button" class="form-option" data-field="age_range" data-value="25-34">
                <i class="fas fa-user-tie" style="font-size: 1.5rem; color: var(--primary);"></i>
                25-34
              </button>
              <button type="button" class="form-option" data-field="age_range" data-value="35-44">
                <i class="fas fa-user" style="font-size: 1.5rem; color: var(--primary);"></i>
                35-44
              </button>
              <button type="button" class="form-option" data-field="age_range" data-value="45-54">
                <i class="fas fa-user-check" style="font-size: 1.5rem; color: var(--primary);"></i>
                45-54
              </button>
              <button type="button" class="form-option" data-field="age_range" data-value="mas_54">
                <i class="fas fa-user-clock" style="font-size: 1.5rem; color: var(--primary);"></i>
                M√°s de 54
              </button>
            </div>
          </div>

          <div class="profile-field">
            <label style="display: block; font-weight: 600; margin-bottom: 1rem; font-size: 1.1rem;">G√©nero:</label>
            <div class="form-options" id="genderOptions">
              <button type="button" class="form-option" data-field="gender" data-value="hombre">
                <i class="fas fa-mars" style="font-size: 1.5rem; color: var(--primary);"></i>
                Hombre
              </button>
              <button type="button" class="form-option" data-field="gender" data-value="mujer">
                <i class="fas fa-venus" style="font-size: 1.5rem; color: var(--primary);"></i>
                Mujer
              </button>
              <button type="button" class="form-option" data-field="gender" data-value="no_binario">
                <i class="fas fa-genderless" style="font-size: 1.5rem; color: var(--primary);"></i>
                No binario
              </button>
            </div>
          </div>
        </div>

        <div class="text-center mt-2">
          <button id="createProfileBtn" class="btn btn-primary" onclick="submitUserProfile()" disabled style="opacity: 0.6;">
            <i class="fas fa-user-plus"></i>
            Selecciona todas las opciones
          </button>
        </div>
      </div>

      <!-- Mode Selector -->
      <div id="modeSelector" class="form-section hidden">
        <h3 class="text-center mb-2">üëó ¬øC√≥mo quieres usar NoShopiA?</h3>
        <p class="text-center mb-2" style="opacity: 0.8;">Elige la forma que mejor se adapte a tu estilo</p>

        <div class="grid grid-2">
          <div class="card card-compact" onclick="enableIntelligentCloset()" style="cursor: pointer;">
            <div class="card-icon">üß†</div>
            <h4 style="color: #000000; margin-bottom: 0.5rem;">Closet Inteligente con IA</h4>
            <p style="opacity: 0.7; font-size: 0.9rem;">IA detecta autom√°ticamente tus prendas y las organiza por categor√≠as (m√°x 15)</p>
          </div>

          <div class="card card-compact" onclick="enableDirectMode()" style="cursor: pointer;">
            <div class="card-icon">‚ö°</div>
            <h4 style="color: #000000; margin-bottom: 0.5rem;">Recomendaciones R√°pidas</h4>
            <p style="opacity: 0.7; font-size: 0.9rem;">Sube fotos directamente sin organizaci√≥n (m√°x: 3-3-5)</p>
          </div>
        </div>
      </div>

      <!-- CLOSET INTELIGENTE REAL CON IA -->
      <div id="intelligentClosetContainer" class="intelligent-closet hidden">
        <div class="closet-header">
          <div>
            <h2 style="margin: 0; font-size: 1.8rem;">üß† Closet Inteligente con IA</h2>
            <p style="margin: 0.5rem 0 0 0; opacity: 0.8;" id="userEmailCloset">usuario@email.com</p>
          </div>
          <button class="btn btn-primary" onclick="enableDirectMode()">‚ö° Modo R√°pido</button>
        </div>

        <!-- AI Detection Status -->
        <div class="ai-detection-status" id="aiDetectionStatus">
          <div class="ai-detection-text">üß† IA detectando y categorizando prendas...</div>
          <div class="ai-progress">
            <div class="ai-progress-bar" id="aiProgressBar"></div>
          </div>
          <div style="font-size: 0.9rem; margin-top: 0.5rem; opacity: 0.8;" id="aiStatusText">Analizando colores, formas y estilos...</div>
        </div>

        <!-- Smart Upload Area -->
        <div class="smart-upload-area" id="smartUploadArea" onclick="triggerSmartUpload()">
          <div style="font-size: 3rem; margin-bottom: 1rem;">üì∏</div>
          <h3>Sube tus prendas aqu√≠</h3>
          <p style="opacity: 0.8; margin: 1rem 0;">La IA detectar√° autom√°ticamente si es superior, inferior o calzado</p>
          <div style="background: var(--success); color: white; padding: 0.5rem 1.5rem; border-radius: 20px; display: inline-block; margin-top: 1rem; font-weight: 600;">
            üß† Detecci√≥n Autom√°tica Activada
          </div>
        </div>

        <!-- Closet Navigation Inteligente -->
        <div class="closet-navigation">
          <button class="closet-nav-item active" data-type="tops">
            <i class="fas fa-tshirt"></i> Superiores
            <span class="nav-badge" id="topsCountNav">0</span>
          </button>
          <button class="closet-nav-item" data-type="bottoms">
            <i class="fas fa-user-tie"></i> Inferiores
            <span class="nav-badge" id="bottomsCountNav">0</span>
          </button>
          <button class="closet-nav-item" data-type="shoes">
            <i class="fas fa-shoe-prints"></i> Calzado
            <span class="nav-badge" id="shoesCountNav">0</span>
          </button>
        </div>

        <!-- Intelligent Categories Display -->
        <div id="intelligentCategoriesContainer">
          <div class="intelligent-categories" id="intelligentCategories">
            <!-- Categor√≠as se generan din√°micamente -->
          </div>
        </div>

        <!-- Smart Selection Panel -->
        <div class="smart-selection-panel">
          <h3 style="text-align: center; margin-bottom: 2rem; color: #000;">üéØ Selecciona prendas para generar recomendaciones</h3>
          
          <div class="selection-summary">
            <div class="selection-category" id="selectionTops">
              <span class="selection-count" id="selectedTopsCount">0</span>
              <div class="selection-label">Superiores seleccionadas</div>
              <div class="selected-items-preview" id="selectedTopsPreview"></div>
            </div>
            <div class="selection-category" id="selectionBottoms">
              <span class="selection-count" id="selectedBottomsCount">0</span>
              <div class="selection-label">Inferiores seleccionadas</div>
              <div class="selected-items-preview" id="selectedBottomsPreview"></div>
            </div>
            <div class="selection-category" id="selectionShoes">
              <span class="selection-count" id="selectedShoesCount">0</span>
              <div class="selection-label">Calzado seleccionado</div>
              <div class="selected-items-preview" id="selectedShoesPreview"></div>
            </div>
          </div>

          <div class="text-center">
            <button class="btn btn-success" onclick="generateFromIntelligentCloset()" id="intelligentGenerateBtn" disabled>
              <i class="fas fa-magic"></i> Selecciona al menos 1 de cada tipo
            </button>
          </div>
        </div>
      </div>

      <!-- Occasion Selector -->
      <div id="occasionSelector" class="form-section hidden">
        <h3 class="text-center mb-2">¬øQu√© planes tienes para esta ocasi√≥n?</h3>
        <div class="grid grid-5" id="occasionGrid">
          <button class="card card-compact" style="cursor: pointer;" data-occasion="oficina">
            <i class="fas fa-briefcase" style="font-size: 2rem; color: var(--primary); margin-bottom: 0.8rem;"></i>
            <span style="color: #000000; font-weight: 500;">Toca Oficina</span>
          </button>
          <button class="card card-compact" style="cursor: pointer;" data-occasion="deportivo">
            <i class="fas fa-dumbbell" style="font-size: 2rem; color: var(--primary); margin-bottom: 0.8rem;"></i>
            <span style="color: #000000; font-weight: 500;">Deportes/Gym</span>
          </button>
          <button class="card card-compact" style="cursor: pointer;" data-occasion="casual">
            <i class="fas fa-users" style="font-size: 2rem; color: var(--primary); margin-bottom: 0.8rem;"></i>
            <span style="color: #000000; font-weight: 500;">Junta casual</span>
          </button>
          <button class="card card-compact" style="cursor: pointer;" data-occasion="formal">
            <i class="fas fa-black-tie" style="font-size: 2rem; color: var(--primary); margin-bottom: 0.8rem;"></i>
            <span style="color: #000000; font-weight: 500;">Outfit Formal</span>
          </button>
          <button class="card card-compact" style="cursor: pointer;" data-occasion="matrimonio">
            <i class="fas fa-ring" style="font-size: 2rem; color: var(--primary); margin-bottom: 0.8rem;"></i>
            <span style="color: #000000; font-weight: 500;">Matrimonio</span>
          </button>
        </div>
      </div>

      <!-- Upload Area (Modo Directo) -->
      <div class="upload-area hidden" id="uploadArea">
        <div id="countersDisplay" class="counter-display">
          <div class="counter-item" id="topsCounter">Superiores: 0/3</div>
          <div class="counter-item" id="bottomsCounter">Inferiores: 0/3</div>
          <div class="counter-item" id="shoesCounter">Zapatos: 0/5</div>
        </div>

        <div class="grid grid-3">
          <div class="card card-compact">
            <i class="fas fa-tshirt" style="font-size: 2.5rem; color: var(--primary); margin-bottom: 1rem;"></i>
            <h4 style="color: #000000;">Parte Superior</h4>
            <p style="color: #000000; opacity: 0.8;">Camisas, blusas, su√©teres</p>
            <label for="tops-upload" class="file-label">üì§ Subir Superiores</label>
            <input type="file" id="tops-upload" class="file-input" accept="image/*" multiple />
            <div id="tops-preview" class="preview-area"></div>
          </div>

          <div class="card card-compact">
            <i class="fas fa-user-tie" style="font-size: 2.5rem; color: var(--primary); margin-bottom: 1rem;"></i>
            <h4 style="color: #000000;">Parte Inferior</h4>
            <p style="color: #000000; opacity: 0.8;">Pantalones, faldas, shorts</p>
            <label for="bottoms-upload" class="file-label">üì§ Subir Inferiores</label>
            <input type="file" id="bottoms-upload" class="file-input" accept="image/*" multiple />
            <div id="bottoms-preview" class="preview-area"></div>
          </div>

          <div class="card card-compact">
            <i class="fas fa-shoe-prints" style="font-size: 2.5rem; color: var(--primary); margin-bottom: 1rem;"></i>
            <h4 style="color: #000000;">Calzado</h4>
            <p style="color: #000000; opacity: 0.8;">Zapatos, sneakers, botas</p>
            <label for="shoes-upload" class="file-label">üì§ Subir Zapatos</label>
            <input type="file" id="shoes-upload" class="file-input" accept="image/*" multiple />
            <div id="shoes-preview" class="preview-area"></div>
          </div>
        </div>

        <div id="combinationsDisplay" class="combinations-info hidden">
          <div class="combinations-formula" id="combinationsFormula">1 √ó 1 √ó 1 = 1 combinaci√≥n posible</div>
          <div class="combinations-result" id="combinationsResult">Se mostrar√°n 1 recomendaci√≥n</div>
        </div>

        <div class="card" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(34, 197, 94, 0.05));">
          <h3 class="mb-2">üöÄ ¬°Genera tus Recomendaciones!</h3>
          <p class="mb-2" style="opacity: 0.8;">Nuestra IA analizar√° todas las combinaciones posibles</p>
          <div class="notification info hidden" id="processingTimer" style="position: static; margin: 1rem 0; animation: none;">
            ‚è±Ô∏è Procesando... <span id="timerDisplay">0.0s</span>
          </div>
          <button class="btn btn-success" onclick="generateRecommendations()" id="generateBtn" disabled>
            <i class="fas fa-magic"></i>Sube fotos de cada categor√≠a para continuar
          </button>
        </div>

        <div id="result" class="hidden"></div>
      </div>

      <!-- Invisible file inputs -->
      <input type="file" id="smart-upload" class="file-input" accept="image/*" multiple />
    </div>
  </section>

  <script>
    // CONFIGURACI√ìN Y VARIABLES GLOBALES COMPLETAS
    const CONFIG = {
      GOOGLE_CLIENT_ID: "326940877598-ko13n1qcqkkugkoo6gu2n1avs46al09p.apps.googleusercontent.com",
      DIRECT_MODE_LIMITS: { tops: 3, bottoms: 3, shoes: 5 },
      INTELLIGENT_CLOSET_LIMIT: 15,
      BACKEND_URL: 'https://noshopia-production.up.railway.app'
    };

    // SISTEMA DE CATEGORIZACI√ìN INTELIGENTE AVANZADO
    const INTELLIGENT_CATEGORIES = {
      tops: {
        "shirt": { name: "Camisas", icon: "üëî", keywords: ["shirt", "dress shirt", "button", "collar"], color: "#3b82f6", confidence: 0.95 },
        "blouse": { name: "Blusas", icon: "üëö", keywords: ["blouse", "silk blouse", "flowy"], color: "#ec4899", confidence: 0.90 },
        "sweater": { name: "Su√©teres", icon: "üß•", keywords: ["sweater", "knitted", "wool", "pullover", "cardigan"], color: "#f59e0b", confidence: 0.92 },
        "tshirt": { name: "Poleras", icon: "üëï", keywords: ["t-shirt", "tee", "graphic", "tank top", "casual"], color: "#10b981", confidence: 0.96 },
        "jacket": { name: "Chaquetas", icon: "üß•", keywords: ["jacket", "leather", "denim", "blazer", "outer"], color: "#6b7280", confidence: 0.88 },
        "dress": { name: "Vestidos", icon: "üëó", keywords: ["dress", "summer dress", "evening dress", "gown"], color: "#8b5cf6", confidence: 0.94 }
      },
      bottoms: {
        "jeans": { name: "Jeans", icon: "üëñ", keywords: ["jeans", "denim", "blue jeans", "ripped"], color: "#1e40af", confidence: 0.97 },
        "pants": { name: "Pantalones", icon: "üëñ", keywords: ["pants", "trousers", "formal pants", "chinos", "slacks"], color: "#3b82f6", confidence: 0.92 },
        "skirt": { name: "Faldas", icon: "üëó", keywords: ["skirt", "midi skirt", "pencil skirt", "mini skirt"], color: "#ec4899", confidence: 0.94 },
        "shorts": { name: "Shorts", icon: "ü©≥", keywords: ["shorts", "athletic shorts", "bermuda"], color: "#10b981", confidence: 0.96 }
      },
      shoes: {
        "sneakers": { name: "Zapatillas", icon: "üëü", keywords: ["sneakers", "running shoes", "athletic shoes", "trainers"], color: "#3b82f6", confidence: 0.96 },
        "dress_shoes": { name: "Zapatos Formales", icon: "üëû", keywords: ["dress shoes", "leather shoes", "formal shoes", "oxfords"], color: "#1f2937", confidence: 0.93 },
        "boots": { name: "Botas", icon: "ü•æ", keywords: ["boots", "ankle boots", "hiking boots", "combat boots"], color: "#92400e", confidence: 0.91 },
        "heels": { name: "Tacones", icon: "üë†", keywords: ["heels", "stiletto heels", "pumps", "high heels"], color: "#ec4899", confidence: 0.94 }
      }
    };

    // Variables globales del sistema inteligente
    let isLoggedIn = false, currentUser = null, userProfile = null;
    let selectedOccasion = '', intelligentClosetMode = false, directMode = false;
    let activeClosetType = 'tops';
    let uploadedFiles = { tops: [], bottoms: [], shoes: [] };
    let uploadedImages = { tops: [], bottoms: [], shoes: [] };
    let selectedProfileData = {};
    
    // Closet Inteligente
    let intelligentClosetItems = { tops: {}, bottoms: {}, shoes: {} };
    let selectedClosetItems = { tops: new Set(), bottoms: new Set(), shoes: new Set() };
    let savedRecommendations = [];

    // NOTIFICACIONES MEJORADAS
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.innerHTML = `
        <div style="display: flex; align-items: center; gap: 0.5rem;">
          <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
          <span>${message}</span>
        </div>
      `;
      document.body.appendChild(notification);
      setTimeout(() => notification.remove(), type === 'error' ? 6000 : 4000);
    }

    // MOBILE MENU
    window.toggleMobileMenu = function() {
      const mobileNav = document.getElementById('mobileNav');
      mobileNav.classList.toggle('active');
    };

    // SMOOTH SCROLLING
    function scrollToSection(sectionId) {
      const section = document.getElementById(sectionId);
      if (section) {
        section.scrollIntoView({ behavior: 'smooth', block: 'start' });
        
        // Update active nav pill
        document.querySelectorAll('.nav-pill').forEach(pill => pill.classList.remove('active'));
        const navPill = document.querySelector(`[data-section="${sectionId}"]`);
        if (navPill) navPill.classList.add('active');
      }
    }

    // FUNCI√ìN PRINCIPAL DEL BOT√ìN DE LOGIN
    window.triggerGoogleLogin = function() {
      console.log('üîê Iniciando proceso de login con Google...');
      
      const btn = document.getElementById('customGoogleLoginBtn');
      
      // Mostrar estado de carga
      btn.disabled = true;
      btn.innerHTML = '<div class="loading"></div> Conectando...';
      
      try {
        if (window.google && window.google.accounts && window.google.accounts.id) {
          // Usar la API de Google Sign-In
          window.google.accounts.id.prompt((notification) => {
            console.log('Google prompt notification:', notification);
            
            // Restaurar bot√≥n si se cancela
            if (notification.isNotDisplayed() || notification.isSkippedMoment()) {
              resetLoginButton();
            }
          });
        } else {
          throw new Error('Google Sign-In API no disponible');
        }
      } catch (error) {
        console.error('‚ùå Error en triggerGoogleLogin:', error);
        showNotification('Error al conectar con Google. Intenta recargar la p√°gina.', 'error');
        resetLoginButton();
      }
    };

    function resetLoginButton() {
      const btn = document.getElementById('customGoogleLoginBtn');
      if (btn) {
        btn.disabled = false;
        btn.innerHTML = '<i class="fab fa-google" style="margin-right: 8px;"></i>Iniciar Sesi√≥n';
      }
    }

    // GOOGLE AUTH - ARREGLADO: Solo una instancia
    window.handleCredentialResponse = function(response) {
      console.log('üîê Google Auth Response:', response);
      
      try {
        if (!response?.credential) throw new Error('No credential received');

        const responsePayload = decodeJwtResponse(response.credential);
        if (!responsePayload?.email) throw new Error('Invalid user data');

        currentUser = {
          email: responsePayload.email,
          name: responsePayload.name || responsePayload.email,
          picture: responsePayload.picture || '',
          sub: responsePayload.sub
        };

        isLoggedIn = true;
        updateAuthUI();
        loadUserData();

        const existingProfile = localStorage.getItem(`noshopia_profile_${currentUser.email}`);

        if (existingProfile) {
          userProfile = JSON.parse(existingProfile);
          showNotification(`¬°Bienvenido de vuelta, ${currentUser.name}!`, 'success');
          showModeSelector();
        } else {
          document.getElementById('welcomeSection').classList.remove('hidden');
          document.getElementById('profileForm').classList.remove('hidden');
          showNotification('¬°Completa tu perfil para comenzar!', 'success');
          scrollToSection('upload');
        }

      } catch (error) {
        console.error('‚ùå Auth Error:', error);
        showNotification(`Error de autenticaci√≥n: ${error.message}`, 'error');
        currentUser = null;
        isLoggedIn = false;
        updateAuthUI();
      }
    };

    function decodeJwtResponse(token) {
      const base64Url = token.split('.')[1];
      const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      const jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
      }).join(''));
      return JSON.parse(jsonPayload);
    }

    function updateAuthUI() {
      const googleLoginContainer = document.getElementById('googleLoginContainer');
      const userInfo = document.getElementById('userInfo');

      if (isLoggedIn && currentUser) {
        if (googleLoginContainer) googleLoginContainer.style.display = 'none';
        if (userInfo) {
          userInfo.classList.add('show');
          document.getElementById('userName').textContent = currentUser.name;
          if (currentUser.picture) document.getElementById('userAvatar').src = currentUser.picture;
        }
      } else {
        if (googleLoginContainer) googleLoginContainer.style.display = 'block';
        if (userInfo) userInfo.classList.remove('show');
        resetLoginButton();
      }
    }

    window.logout = function() {
      // Reset all variables
      currentUser = null; isLoggedIn = false; userProfile = null; selectedOccasion = '';
      uploadedFiles = { tops: [], bottoms: [], shoes: [] };
      uploadedImages = { tops: [], bottoms: [], shoes: [] };
      intelligentClosetItems = { tops: {}, bottoms: {}, shoes: {} };
      selectedClosetItems = { tops: new Set(), bottoms: new Set(), shoes: new Set() };
      savedRecommendations = []; intelligentClosetMode = false; directMode = false;

      updateAuthUI(); hideAllSections();
      
      if (window.google?.accounts) window.google.accounts.id.disableAutoSelect();
      showNotification('Sesi√≥n cerrada exitosamente', 'info');
      window.scrollTo({top: 0, behavior: 'smooth'});
    };

    // GESTI√ìN DE DATOS DEL USUARIO
    function loadUserData() {
      if (!currentUser?.email) return;
      
      const closetData = localStorage.getItem(`noshopia_intelligent_closet_${currentUser.email}`);
      if (closetData) {
        const data = JSON.parse(closetData);
        intelligentClosetItems = data.intelligentClosetItems || { tops: {}, bottoms: {}, shoes: {} };
        console.log('üß† Closet Inteligente cargado:', getTotalIntelligentClosetItems(), 'prendas');
      }
      
      const savedData = localStorage.getItem(`noshopia_saved_${currentUser.email}`);
      if (savedData) {
        savedRecommendations = JSON.parse(savedData);
        console.log('‚≠ê Recomendaciones guardadas:', savedRecommendations.length);
      }
    }

    function saveUserData() {
      if (!currentUser?.email) return;
      
      const closetData = {
        email: currentUser.email,
        intelligentClosetItems,
        lastUpdated: new Date().toISOString(),
        totalItems: getTotalIntelligentClosetItems()
      };
      localStorage.setItem(`noshopia_intelligent_closet_${currentUser.email}`, JSON.stringify(closetData));
      
      if (savedRecommendations.length > 0) {
        localStorage.setItem(`noshopia_saved_${currentUser.email}`, JSON.stringify(savedRecommendations));
      }
    }

    // PROFILE MANAGEMENT
    function checkProfileCompletion() {
      const requiredFields = ['skin_color', 'age_range', 'gender'];
      const selections = {};

      document.querySelectorAll('.form-option.selected').forEach(option => {
        selections[option.dataset.field] = option.dataset.value;
      });

      const isComplete = requiredFields.every(field => selections[field]);
      const createBtn = document.getElementById('createProfileBtn');

      createBtn.disabled = !isComplete;
      createBtn.style.opacity = isComplete ? '1' : '0.6';
      createBtn.innerHTML = isComplete ? 
        '<i class="fas fa-user-plus"></i> Crear Mi Perfil' : 
        '<i class="fas fa-user-plus"></i> Selecciona todas las opciones';

      selectedProfileData = selections;
    }

    window.submitUserProfile = function() {
      if (!currentUser || !selectedProfileData) {
        showNotification('Error: Datos incompletos', 'error');
        return;
      }

      const profileData = {
        email: currentUser.email,
        name: currentUser.name,
        picture: currentUser.picture,
        ...selectedProfileData,
        created_at: new Date().toISOString()
      };

      localStorage.setItem(`noshopia_profile_${currentUser.email}`, JSON.stringify(profileData));
      userProfile = profileData;

      hideAllSections();
      showNotification('¬°Perfil creado exitosamente!', 'success');
      setTimeout(() => showModeSelector(), 1000);
    };

    // MODE SELECTION
    function showModeSelector() {
      hideAllSections();
      document.getElementById('modeSelector').classList.remove('hidden');
      scrollToSection('upload');
    }

    // CLOSET INTELIGENTE REAL CON IA
    window.enableIntelligentCloset = function() {
      intelligentClosetMode = true;
      directMode = false;
      hideAllSections();
      
      const container = document.getElementById('intelligentClosetContainer');
      container.classList.remove('hidden');
      
      document.getElementById('userEmailCloset').textContent = currentUser.email;
      
      updateIntelligentClosetUI();
      renderIntelligentCategories();
      showNotification('üß† Closet Inteligente con IA activado!', 'success');
      scrollToSection('upload');
      
      // Mostrar selector de ocasi√≥n despu√©s de un momento
      setTimeout(() => {
        if (!selectedOccasion) {
          showOccasionSelector();
        }
      }, 2000);
    };

    window.enableDirectMode = function() {
      directMode = true;
      intelligentClosetMode = false;
      hideAllSections();
      showNotification('Modo Recomendaciones R√°pidas activado', 'success');
      showOccasionSelector();
    };

    function showOccasionSelector() {
      document.getElementById('occasionSelector').classList.remove('hidden');
      scrollToSection('upload');
    }

    // FUNCIONES DEL CLOSET INTELIGENTE
    function getTotalIntelligentClosetItems() {
      let total = 0;
      ['tops', 'bottoms', 'shoes'].forEach(type => {
        Object.values(intelligentClosetItems[type]).forEach(category => {
          total += category.length;
        });
      });
      return total;
    }

    function updateIntelligentClosetUI() {
      const total = getTotalIntelligentClosetItems();
      const remaining = Math.max(0, CONFIG.INTELLIGENT_CLOSET_LIMIT - total);
      
      // Update navigation badges
      ['tops', 'bottoms', 'shoes'].forEach(type => {
        const count = Object.values(intelligentClosetItems[type]).reduce((sum, category) => sum + category.length, 0);
        const badge = document.getElementById(`${type}CountNav`);
        if (badge) {
          badge.textContent = count;
          badge.style.display = count > 0 ? 'flex' : 'none';
        }
      });
      
      updateIntelligentGenerateButton();
    }

    // UPLOAD INTELIGENTE CON IA REAL
    window.triggerSmartUpload = function() {
      const remaining = CONFIG.INTELLIGENT_CLOSET_LIMIT - getTotalIntelligentClosetItems();
      
      if (remaining <= 0) {
        showNotification(`üß† Closet lleno (${CONFIG.INTELLIGENT_CLOSET_LIMIT}/15). Elimina prendas para agregar nuevas.`, 'error');
        return;
      }
      
      const input = document.getElementById('smart-upload');
      input.onchange = handleIntelligentUpload;
      input.click();
    };

    async function handleIntelligentUpload(event) {
      const files = Array.from(event.target.files);
      if (files.length === 0) return;
      
      const remaining = CONFIG.INTELLIGENT_CLOSET_LIMIT - getTotalIntelligentClosetItems();
      
      if (files.length > remaining) {
        showNotification(`Solo puedes subir ${remaining} prendas m√°s`, 'error');
        event.target.value = '';
        return;
      }
      
      // Activar indicador de IA
      const aiStatus = document.getElementById('aiDetectionStatus');
      const progressBar = document.getElementById('aiProgressBar');
      const statusText = document.getElementById('aiStatusText');
      
      aiStatus.classList.add('active');
      progressBar.style.width = '0%';
      
      showNotification('üß† IA analizando y categorizando prendas...', 'info');
      
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const progress = ((i + 1) / files.length) * 100;
        
        // Simular detecci√≥n de IA
        statusText.textContent = `Analizando prenda ${i + 1} de ${files.length}...`;
        progressBar.style.width = progress + '%';
        
        try {
          // Simular llamada a IA (en producci√≥n ser√≠a una llamada real al backend)
          const detectionResult = await simulateAIDetection(file);
          
          // Convertir imagen a data URL
          const imageUrl = await fileToDataUrl(file);
          
          // Categorizar autom√°ticamente
          categorizeIntelligentItem(detectionResult.type, detectionResult.category, detectionResult.item, imageUrl, file);
          
          await new Promise(resolve => setTimeout(resolve, 1000)); // Simular procesamiento
          
        } catch (error) {
          console.error('Error en detecci√≥n IA:', error);
          showNotification(`Error procesando ${file.name}`, 'error');
        }
      }
      
      // Finalizar proceso
      setTimeout(() => {
        aiStatus.classList.remove('active');
        finishIntelligentUpload(files.length);
      }, 2000);
      
      event.target.value = '';
    }

    // SIMULACI√ìN DE DETECCI√ìN IA (reemplazar con llamada real al backend)
    async function simulateAIDetection(file) {
      // Simular an√°lisis de IA basado en el nombre del archivo
      const fileName = file.name.toLowerCase();
      
      let detectedType = 'tops';
      let detectedCategory = 'tshirt';
      let detectedItem = 'Prenda superior';
      
      // L√≥gica simple de detecci√≥n basada en palabras clave
      if (fileName.includes('jean') || fileName.includes('pantalon') || fileName.includes('falda')) {
        detectedType = 'bottoms';
        detectedCategory = fileName.includes('jean') ? 'jeans' : 'pants';
        detectedItem = fileName.includes('jean') ? 'Jeans' : 'Pantalones';
      } else if (fileName.includes('zapato') || fileName.includes('zapatilla') || fileName.includes('boot')) {
        detectedType = 'shoes';
        detectedCategory = fileName.includes('zapatilla') ? 'sneakers' : 'dress_shoes';
        detectedItem = fileName.includes('zapatilla') ? 'Zapatillas' : 'Zapatos formales';
      } else if (fileName.includes('camisa') || fileName.includes('shirt')) {
        detectedCategory = 'shirt';
        detectedItem = 'Camisa';
      } else if (fileName.includes('polera') || fileName.includes('tshirt')) {
        detectedCategory = 'tshirt';
        detectedItem = 'Polera';
      }
      
      return {
        type: detectedType,
        category: detectedCategory,
        item: detectedItem,
        confidence: Math.random() * 0.3 + 0.7 // 70-100% confianza
      };
    }

    function fileToDataUrl(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    function categorizeIntelligentItem(type, categoryId, detectedItem, imageUrl, file) {
      if (!intelligentClosetItems[type][categoryId]) {
        intelligentClosetItems[type][categoryId] = [];
      }
      
      const item = {
        id: Date.now() + Math.random(),
        imageUrl,
        file,
        detectedItem,
        category: categoryId,
        addedAt: new Date().toISOString(),
        aiDetected: true
      };
      
      intelligentClosetItems[type][categoryId].push(item);
      
      console.log(`üß† Prenda categorizada: ${detectedItem} en ${type}/${categoryId}`);
    }

    function finishIntelligentUpload(count) {
      saveUserData();
      updateIntelligentClosetUI();
      renderIntelligentCategories();
      
      const remaining = CONFIG.INTELLIGENT_CLOSET_LIMIT - getTotalIntelligentClosetItems();
      showNotification(`üß† ${count} prenda${count !== 1 ? 's' : ''} detectada${count !== 1 ? 's' : ''} y categorizada${count !== 1 ? 's' : ''} autom√°ticamente! Te quedan ${remaining} espacios.`, 'success');
    }

    function renderIntelligentCategories() {
      const container = document.getElementById('intelligentCategories');
      const items = intelligentClosetItems[activeClosetType];
      
      if (!items || Object.keys(items).length === 0) {
        container.innerHTML = `
          <div style="grid-column: 1 / -1; text-align: center; padding: 3rem;">
            <div style="font-size: 4rem; margin-bottom: 1rem; opacity: 0.5;">üß†</div>
            <h3 style="color: #666; margin-bottom: 1rem;">Tu closet de ${activeClosetType === 'tops' ? 'superiores' : activeClosetType === 'bottoms' ? 'inferiores' : 'calzado'} est√° vac√≠o</h3>
            <p style="opacity: 0.7;">Sube fotos para que la IA las detecte y organice autom√°ticamente</p>
          </div>
        `;
        return;
      }
      
      let html = '';
      
      Object.entries(items).forEach(([categoryId, categoryItems]) => {
        if (categoryItems.length === 0) return;
        
        const categoryInfo = INTELLIGENT_CATEGORIES[activeClosetType][categoryId];
        if (!categoryInfo) return;
        
        const allAiDetected = categoryItems.every(item => item.aiDetected);
        
        html += `
          <div class="smart-category ${categoryItems.length > 0 ? 'has-items' : ''} ${allAiDetected ? 'auto-detected' : ''}">
            <div class="category-header">
              <div class="category-icon" style="background: ${categoryInfo.color};">
                ${categoryInfo.icon}
              </div>
              <div class="category-info">
                <h4>${categoryInfo.name}</h4>
                <p>${categoryItems.length} prenda${categoryItems.length !== 1 ? 's' : ''}</p>
                ${allAiDetected ? `<span class="ai-confidence">${Math.round(categoryInfo.confidence * 100)}% IA</span>` : ''}
              </div>
            </div>
            <div class="smart-items-grid">
              ${categoryItems.map((item, index) => {
                const isSelected = selectedClosetItems[activeClosetType].has(item.id);
                return `
                  <div class="smart-item ${isSelected ? 'selected' : ''}" data-id="${item.id}">
                    <img src="${item.imageUrl}" alt="${categoryInfo.name}">
                    <div class="item-controls">
                      <button class="item-btn select" onclick="toggleItemSelection('${activeClosetType}', '${item.id}')" title="${isSelected ? 'Deseleccionar' : 'Seleccionar'}">
                        ${isSelected ? '‚úì' : '+'}
                      </button>
                      <button class="item-btn" onclick="removeIntelligentItem('${activeClosetType}', '${categoryId}', ${index})" title="Eliminar">√ó</button>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
      updateSelectionUI();
    }

    // SISTEMA DE SELECCI√ìN MEJORADO
    window.toggleItemSelection = function(type, itemId) {
      const selectedSet = selectedClosetItems[type];
      
      if (selectedSet.has(itemId)) {
        // DESELECCIONAR - NO eliminar, solo deseleccionar
        selectedSet.delete(itemId);
        showNotification('Prenda deseleccionada', 'info');
      } else {
        // SELECCIONAR
        selectedSet.add(itemId);
        showNotification('Prenda seleccionada', 'success');
      }
      
      renderIntelligentCategories(); // Re-renderizar para mostrar cambios
      updateIntelligentGenerateButton();
    };

    window.removeIntelligentItem = function(type, categoryId, index) {
      const categoryInfo = INTELLIGENT_CATEGORIES[type][categoryId];
      const itemName = categoryInfo ? categoryInfo.name : categoryId;
      
      if (!confirm(`¬øEliminar esta prenda de ${itemName}?`)) return;
      
      const item = intelligentClosetItems[type][categoryId][index];
      
      // Eliminar de selecciones
      selectedClosetItems[type].delete(item.id);
      
      // Eliminar del closet
      intelligentClosetItems[type][categoryId].splice(index, 1);
      
      // Si la categor√≠a queda vac√≠a, eliminarla
      if (intelligentClosetItems[type][categoryId].length === 0) {
        delete intelligentClosetItems[type][categoryId];
      }
      
      saveUserData();
      updateIntelligentClosetUI();
      renderIntelligentCategories();
      
      showNotification(`Prenda eliminada de ${itemName}`, 'info');
    };

    function updateSelectionUI() {
      const types = ['tops', 'bottoms', 'shoes'];
      
      types.forEach(type => {
        const count = selectedClosetItems[type].size;
        const countElement = document.getElementById(`selected${type.charAt(0).toUpperCase() + type.slice(1)}Count`);
        const categoryElement = document.getElementById(`selection${type.charAt(0).toUpperCase() + type.slice(1)}`);
        const previewElement = document.getElementById(`selected${type.charAt(0).toUpperCase() + type.slice(1)}Preview`);
        
        if (countElement) countElement.textContent = count;
        if (categoryElement) {
          categoryElement.className = `selection-category ${count > 0 ? 'has-selection' : ''}`;
        }
        
        // Mostrar preview de seleccionados
        if (previewElement) {
          const selectedIds = Array.from(selectedClosetItems[type]);
          const selectedItems = selectedIds.map(id => {
            // Buscar el item en todas las categor√≠as
            for (const categoryId in intelligentClosetItems[type]) {
              const item = intelligentClosetItems[type][categoryId].find(item => item.id === id);
              if (item) return item;
            }
            return null;
          }).filter(Boolean);
          
          previewElement.innerHTML = selectedItems.map(item => 
            `<img src="${item.imageUrl}" class="mini-preview" alt="Seleccionada">`
          ).join('');
        }
      });
    }

    function updateIntelligentGenerateButton() {
      const btn = document.getElementById('intelligentGenerateBtn');
      if (!btn) return;
      
      const hasSelections = selectedClosetItems.tops.size > 0 && 
                           selectedClosetItems.bottoms.size > 0 && 
                           selectedClosetItems.shoes.size > 0;
      
      if (hasSelections && selectedOccasion) {
        const totalCombinations = selectedClosetItems.tops.size * selectedClosetItems.bottoms.size * selectedClosetItems.shoes.size;
        btn.disabled = false;
        btn.style.opacity = '1';
        btn.innerHTML = `<i class="fas fa-magic"></i> Generar ${Math.min(3, totalCombinations)} Recomendaciones del Closet IA`;
      } else {
        btn.disabled = true;
        btn.style.opacity = '0.6';
        if (!selectedOccasion) {
          btn.innerHTML = '<i class="fas fa-magic"></i> Selecciona una ocasi√≥n primero';
        } else {
          btn.innerHTML = '<i class="fas fa-magic"></i> Selecciona al menos 1 prenda de cada tipo';
        }
      }
    }

    window.generateFromIntelligentCloset = function() {
      if (!selectedOccasion) {
        showOccasionSelector();
        showNotification('Primero selecciona una ocasi√≥n', 'info');
        return;
      }
      
      const hasSelections = selectedClosetItems.tops.size > 0 && 
                           selectedClosetItems.bottoms.size > 0 && 
                           selectedClosetItems.shoes.size > 0;
      
      if (!hasSelections) {
        showNotification('Selecciona al menos 1 prenda de cada tipo', 'error');
        return;
      }
      
      // Obtener archivos de las prendas seleccionadas
      const selectedFiles = { tops: [], bottoms: [], shoes: [] };
      
      ['tops', 'bottoms', 'shoes'].forEach(type => {
        const selectedIds = Array.from(selectedClosetItems[type]);
        selectedIds.forEach(id => {
          // Buscar el item en todas las categor√≠as
          for (const categoryId in intelligentClosetItems[type]) {
            const item = intelligentClosetItems[type][categoryId].find(item => item.id === id);
            if (item && item.file) {
              selectedFiles[type].push(item.file);
              break;
            }
          }
        });
      });
      
      generateRecommendationsWithFiles(selectedFiles);
    };

    // FILE UPLOAD (MODO DIRECTO) - Todas las funciones necesarias
    function handleFileUpload(type, input) {
      const files = Array.from(input.files);
      if (files.length === 0) return;

      const currentCount = uploadedFiles[type].length;
      const maxAllowed = CONFIG.DIRECT_MODE_LIMITS[type] - currentCount;

      if (files.length > maxAllowed) {
        showNotification(`Solo puedes subir ${maxAllowed} ${type} m√°s. M√°ximo: ${CONFIG.DIRECT_MODE_LIMITS[type]}`, 'error');
        input.value = '';
        return;
      }

      files.forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          uploadedFiles[type].push(file);
          uploadedImages[type].push(e.target.result);
          
          updatePreview(type);
          updateCounters();
          updateCombinationsDisplay();
          updateGenerateButton();
        };
        reader.readAsDataURL(file);
      });

      input.value = '';
      showNotification(`${files.length} archivo(s) subidos correctamente`, 'success');
    }

    function updatePreview(type) {
      const preview = document.getElementById(`${type}-preview`);
      if (!preview) return;

      preview.innerHTML = '';
      uploadedImages[type].forEach((imageUrl, index) => {
        const container = document.createElement('div');
        container.className = 'preview-container';
        container.innerHTML = `
          <img src="${imageUrl}" class="preview-image" alt="${type} ${index + 1}">
          <button class="remove-image" onclick="removeImage('${type}', ${index})">√ó</button>
        `;
        preview.appendChild(container);
      });
    }

    window.removeImage = function(type, index) {
      uploadedFiles[type].splice(index, 1);
      uploadedImages[type].splice(index, 1);
      updatePreview(type);
      updateCounters();
      updateCombinationsDisplay();
      updateGenerateButton();
    };

    function updateCounters() {
      ['tops', 'bottoms', 'shoes'].forEach(type => {
        const counter = document.getElementById(`${type}Counter`);
        if (!counter) return;

        const count = uploadedImages[type].length;
        const max = CONFIG.DIRECT_MODE_LIMITS[type];
        
        counter.textContent = `${type.charAt(0).toUpperCase() + type.slice(1)}: ${count}/${max}`;
        counter.className = 'counter-item';
        if (count >= 1) counter.classList.add('counter-success');
      });
    }

    function updateCombinationsDisplay() {
      const display = document.getElementById('combinationsDisplay');
      const formula = document.getElementById('combinationsFormula');
      const result = document.getElementById('combinationsResult');
      
      const topsCount = uploadedImages.tops.length;
      const bottomsCount = uploadedImages.bottoms.length;
      const shoesCount = uploadedImages.shoes.length;

      if (topsCount > 0 || bottomsCount > 0 || shoesCount > 0) {
        display.classList.remove('hidden');
        const totalCombinations = topsCount * bottomsCount * shoesCount;
        const maxRecommendations = Math.min(3, totalCombinations);
        
        formula.textContent = `${topsCount} √ó ${bottomsCount} √ó ${shoesCount} = ${totalCombinations} combinaciones posibles`;
        result.textContent = `Se mostrar√°n las mejores ${maxRecommendations} recomendaciones`;
      } else {
        display.classList.add('hidden');
      }
    }

    function updateGenerateButton() {
      const generateBtn = document.getElementById('generateBtn');
      if (!generateBtn) return;

      const topsCount = uploadedImages.tops.length;
      const bottomsCount = uploadedImages.bottoms.length;
      const shoesCount = uploadedImages.shoes.length;

      const hasMinimum = topsCount >= 1 && bottomsCount >= 1 && shoesCount >= 1 && selectedOccasion;

      if (hasMinimum) {
        const totalCombinations = topsCount * bottomsCount * shoesCount;
        const recommendationsToShow = Math.min(3, totalCombinations);
        generateBtn.disabled = false;
        generateBtn.style.opacity = '1';
        generateBtn.innerHTML = `<i class="fas fa-magic"></i> Generar ${recommendationsToShow} Recomendaci√≥n${recommendationsToShow > 1 ? 'es' : ''}`;
      } else {
        generateBtn.disabled = true;
        generateBtn.style.opacity = '0.6';
        if (!selectedOccasion) {
          generateBtn.innerHTML = '<i class="fas fa-magic"></i> Selecciona una ocasi√≥n primero';
        } else {
          generateBtn.innerHTML = '<i class="fas fa-magic"></i> Sube al menos 1 prenda de cada tipo';
        }
      }
    }

    // RECOMMENDATIONS
    window.generateRecommendations = function() {
      const files = {
        tops: uploadedFiles.tops,
        bottoms: uploadedFiles.bottoms,
        shoes: uploadedFiles.shoes
      };
      generateRecommendationsWithFiles(files);
    };

    function generateRecommendationsWithFiles(files) {
      if (!selectedOccasion) {
        showNotification('Selecciona una ocasi√≥n primero', 'error');
        return;
      }

      const topsCount = files.tops.length;
      const bottomsCount = files.bottoms.length;
      const shoesCount = files.shoes.length;

      if (topsCount < 1 || bottomsCount < 1 || shoesCount < 1) {
        showNotification('Necesitas al menos 1 prenda de cada tipo', 'error');
        return;
      }

      const processingTimer = document.getElementById('processingTimer');
      const generateBtn = document.getElementById('generateBtn') || document.getElementById('intelligentGenerateBtn');

      processingTimer.classList.remove('hidden');
      if (generateBtn) {
        generateBtn.disabled = true;
        generateBtn.innerHTML = '<div class="loading"></div> Procesando con IA...';
      }

      let startTime = Date.now();
      const timerInterval = setInterval(() => {
        document.getElementById('timerDisplay').textContent = ((Date.now() - startTime) / 1000).toFixed(1) + 's';
      }, 100);

      const formData = new FormData();
      files.tops.forEach(file => formData.append('tops', file));
      files.bottoms.forEach(file => formData.append('bottoms', file));
      files.shoes.forEach(file => formData.append('shoes', file));
      formData.append('occasion', selectedOccasion);
      if (currentUser?.email) formData.append('user_email', currentUser.email);

      fetch(`${CONFIG.BACKEND_URL}/api/recommend`, {
        method: 'POST',
        body: formData
      })
      .then(async response => {
        const data = await response.json();
        if (!response.ok) throw new Error(data.message || `Error ${response.status}`);
        return data;
      })
      .then(data => {
        clearInterval(timerInterval);
        processingTimer.classList.add('hidden');
        if (generateBtn) {
          generateBtn.disabled = false;
          generateBtn.innerHTML = intelligentClosetMode ? 
            '<i class="fas fa-magic"></i> Generar Nuevamente' :
            '<i class="fas fa-magic"></i> Generar para otra ocasi√≥n';
        }
        
        renderRecommendations(data);
        showNotification(`¬°Recomendaciones generadas para ${selectedOccasion}!`, 'success');
      })
      .catch(error => {
        console.error('‚ùå Error:', error);
        clearInterval(timerInterval);
        processingTimer.classList.add('hidden');
        if (generateBtn) {
          generateBtn.disabled = false;
          generateBtn.innerHTML = '<i class="fas fa-magic"></i> Reintentar';
        }
        showNotification(`Error: ${error.message}`, 'error');
      });
    }

    function renderRecommendations(data) {
      const result = document.getElementById('result');
      const results = data.results || [];

      if (results.length === 0) {
        result.innerHTML = '<p style="text-align: center; padding: 2rem;">No se encontraron recomendaciones.</p>';
        result.classList.remove('hidden');
        return;
      }

      let bestIndex = 0;
      let highestScore = 0;
      results.forEach((item, index) => {
        const score = item.final_score || 0;
        if (score > highestScore) {
          highestScore = score;
          bestIndex = index;
        }
      });

      const occasionText = {
        'oficina': 'Oficina/Trabajo',
        'deportivo': 'Deportes/Gym',
        'casual': 'Casual',
        'formal': 'Formal',
        'matrimonio': 'Matrimonio'
      };

      let html = `
        <div style="text-align: center; margin-bottom: 2rem;">
          <h2 style="color: #000000;">ü™Ñ Recomendaciones para ${occasionText[selectedOccasion] || selectedOccasion}</h2>
          <p style="color: #000000; opacity: 0.8;">${results.length} combinaciones ${intelligentClosetMode ? 'desde tu Closet Inteligente üß†' : 'optimizadas'}</p>
        </div>
        <div style="display: grid; gap: 2rem;">
      `;

      results.forEach((item, idx) => {
        const scorePercent = Math.round((item.final_score || 0) * 100);
        const isBest = idx === bestIndex;

        const topImage = getImageForCombination('tops', item);
        const bottomImage = getImageForCombination('bottoms', item);
        const shoeImage = getImageForCombination('shoes', item);

        html += `
          <div style="background: var(--background); border: 2px solid ${isBest ? 'var(--gold)' : 'var(--border)'}; border-radius: 20px; padding: 2rem; position: relative;">
            ${isBest ? '<div style="position: absolute; top: -15px; left: 50%; transform: translateX(-50%); background: var(--gold); color: #000000; padding: 0.5rem 1.5rem; border-radius: 20px; font-weight: 800;">‚≠ê MEJOR</div>' : ''}
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; ${isBest ? 'margin-top: 1rem;' : ''}">
              <h3 style="color: #000000; margin: 0;">${intelligentClosetMode ? 'üß†' : ''} Combinaci√≥n ${idx + 1}</h3>
              <div style="display: flex; gap: 0.5rem; align-items: center;">
                <span style="background: ${isBest ? 'var(--gold)' : 'var(--primary)'}; color: ${isBest ? '#000000' : 'white'}; padding: 0.5rem 1rem; border-radius: 15px; font-weight: 700;">${scorePercent}%</span>
                ${intelligentClosetMode ? '<button onclick="saveToFavorites(' + idx + ')" style="background: var(--success); color: white; border: none; padding: 0.5rem 1rem; border-radius: 10px; cursor: pointer;">‚≠ê Guardar</button>' : ''}
              </div>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1rem;">
              <div style="text-align: center;">
                <div style="font-size: 0.8rem; color: #000000; font-weight: 600; margin-bottom: 0.5rem;">üëï SUPERIOR</div>
                <div style="border-radius: 20px; padding: 1rem; min-height: 200px; display: flex; align-items: center; justify-content: center; border: 1px dashed rgba(59, 130, 246, 0.3);">
                  ${topImage ? `<img src="${topImage}" style="max-width: 150px; max-height: 150px; object-fit: contain; border-radius: 15px;" alt="Superior">` : '<div style="color: #666; font-size: 2rem;">üëï</div>'}
                </div>
                <div style="font-size: 0.9rem; color: #000000; opacity: 0.8; margin-top: 0.5rem;">${item.top?.detected_item || 'Superior'}</div>
              </div>
              <div style="text-align: center;">
                <div style="font-size: 0.8rem; color: #000000; font-weight: 600; margin-bottom: 0.5rem;">üëñ INFERIOR</div>
                <div style="border-radius: 20px; padding: 1rem; min-height: 200px; display: flex; align-items: center; justify-content: center; border: 1px dashed rgba(59, 130, 246, 0.3);">
                  ${bottomImage ? `<img src="${bottomImage}" style="max-width: 150px; max-height: 150px; object-fit: contain; border-radius: 15px;" alt="Inferior">` : '<div style="color: #666; font-size: 2rem;">üëñ</div>'}
                </div>
                <div style="font-size: 0.9rem; color: #000000; opacity: 0.8; margin-top: 0.5rem;">${item.bottom?.detected_item || 'Inferior'}</div>
              </div>
              <div style="text-align: center;">
                <div style="font-size: 0.8rem; color: #000000; font-weight: 600; margin-bottom: 0.5rem;">üë¢ CALZADO</div>
                <div style="border-radius: 20px; padding: 1rem; min-height: 200px; display: flex; align-items: center; justify-content: center; border: 1px dashed rgba(59, 130, 246, 0.3);">
                  ${shoeImage ? `<img src="${shoeImage}" style="max-width: 150px; max-height: 150px; object-fit: contain; border-radius: 15px;" alt="Calzado">` : '<div style="color: #666; font-size: 2rem;">üë¢</div>'}
                </div>
                <div style="font-size: 0.9rem; color: #000000; opacity: 0.8; margin-top: 0.5rem;">${item.shoe?.detected_item || 'Calzado'}</div>
              </div>
            </div>
            
            <div style="background: rgba(59, 130, 246, 0.1); border-radius: 10px; padding: 1rem; text-align: center;">
              <div style="color: #000000; font-weight: 600; margin-bottom: 0.5rem;">
                ${item.harmony_type || 'Combinaci√≥n Equilibrada'}
              </div>
              <div style="color: #000000; opacity: 0.8; font-size: 0.9rem;">
                ${item.harmony_description || 'Una mezcla balanceada de colores y estilos'}
              </div>
            </div>
          </div>
        `;
      });

      html += '</div>';
      result.innerHTML = html;
      result.classList.remove('hidden');
      
      window.currentResults = results;
      
      setTimeout(() => {
        result.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }, 100);
    }

    function getImageForCombination(type, item) {
      let images = [];
      
      if (intelligentClosetMode) {
        // Obtener im√°genes del closet inteligente
        Object.values(intelligentClosetItems[type]).forEach(category => {
          category.forEach(item => {
            images.push(item.imageUrl);
          });
        });
      } else {
        // Usar im√°genes del modo directo
        images = uploadedImages[type] || [];
      }
      
      if (!images || images.length === 0) return null;

      let backendIndex;
      if (type === 'tops' && item.top) backendIndex = item.top.index;
      else if (type === 'bottoms' && item.bottom) backendIndex = item.bottom.index;
      else if (type === 'shoes' && item.shoe) backendIndex = item.shoe.index;
      else return null;

      if (typeof backendIndex === 'number' && backendIndex >= 0 && backendIndex < images.length) {
        return images[backendIndex];
      }

      return images[0];
    }

    // GUARDADO DE FAVORITOS
    window.saveToFavorites = function(index) {
      if (!intelligentClosetMode || !window.currentResults) return;
      
      const recommendation = window.currentResults[index];
      savedRecommendations.push({
        id: Date.now(),
        recommendation,
        occasion: selectedOccasion,
        savedAt: new Date().toISOString()
      });
      
      saveUserData();
      showNotification('Recomendaci√≥n guardada en favoritos', 'success');
    };

    // UTILITY FUNCTIONS
    function hideAllSections() {
      ['welcomeSection', 'profileForm', 'modeSelector', 'occasionSelector', 'uploadArea', 'intelligentClosetContainer', 'result'].forEach(id => {
        const element = document.getElementById(id);
        if (element) element.classList.add('hidden');
      });
    }

    // EVENT DELEGATION COMPLETO
    document.addEventListener('click', (e) => {
      // Navigation
      if (e.target.matches('[data-section]')) {
        e.preventDefault();
        const section = e.target.dataset.section;
        scrollToSection(section);
      }

      // Profile options
      if (e.target.matches('.form-option')) {
        const field = e.target.dataset.field;
        document.querySelectorAll(`[data-field="${field}"]`).forEach(opt => opt.classList.remove('selected'));
        e.target.classList.add('selected');
        checkProfileCompletion();
      }

      // Closet navigation tabs (Closet Inteligente)
      if (e.target.matches('.closet-nav-item') || e.target.closest('.closet-nav-item')) {
        const tab = e.target.closest('.closet-nav-item') || e.target;
        const type = tab.dataset.type;
        
        document.querySelectorAll('.closet-nav-item').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        
        activeClosetType = type;
        renderIntelligentCategories();
        
        showNotification(`Navegando a ${type === 'tops' ? 'Superiores' : type === 'bottoms' ? 'Inferiores' : 'Calzado'}`, 'info');
      }

      // Occasion selection
      if (e.target.matches('[data-occasion]') || e.target.closest('[data-occasion]')) {
        const btn = e.target.closest('[data-occasion]') || e.target;
        
        document.querySelectorAll('[data-occasion]').forEach(b => {
          b.style.borderColor = '';
          b.style.background = '';
        });

        btn.style.borderColor = 'var(--success)';
        btn.style.background = 'rgba(16, 185, 129, 0.1)';

        selectedOccasion = btn.dataset.occasion;
        showNotification(`Ocasi√≥n seleccionada: ${selectedOccasion}`, 'success');

        if (intelligentClosetMode) {
          updateIntelligentGenerateButton();
        } else if (directMode) {
          setTimeout(() => {
            document.getElementById('uploadArea').classList.remove('hidden');
            scrollToSection('upload');
            updateGenerateButton();
          }, 500);
        }
      }
    });

    // File upload listeners
    document.addEventListener('change', (e) => {
      if (e.target.matches('.file-input') && e.target.id !== 'smart-upload') {
        const type = e.target.id.replace('-upload', '');
        handleFileUpload(type, e.target);
      }
    });

    // INITIALIZATION COMPLETA - CON CONTROL DE GOOGLE BUTTON
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üöÄ NoShopiA con Closet Inteligente REAL iniciado');
      
      const checkGoogleLoaded = setInterval(() => {
        if (window.google && window.google.accounts) {
          console.log('‚úÖ Google Sign-In API cargada');
          clearInterval(checkGoogleLoaded);
          updateAuthUI();
        }
      }, 500);

      setTimeout(() => {
        clearInterval(checkGoogleLoaded);
        if (!window.google) {
          showNotification('Error cargando autenticaci√≥n. Recarga la p√°gina.', 'error');
        }
      }, 10000);

      // Welcome message despu√©s de un tiempo
      setTimeout(() => {
        if (!isLoggedIn) {
          showNotification('¬°Bienvenido a NoShopiA! Inicia sesi√≥n para comenzar.', 'info');
        }
      }, 2000);
    });

    console.log('‚úÖ NoShopiA con Closet Inteligente REAL completamente cargado y funcional');
  </script>
</body>
</html>
